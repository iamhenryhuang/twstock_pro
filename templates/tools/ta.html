{% extends "layouts/base.html" %}

{% block title %}Technical Analysis | TST{% endblock %}

{% block content %}
<section class="section">
    <div class="container">

        <!-- Header -->
        <div class="text-center mb-xl">
            <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-surface border border-brand mb-md">
                <i class="bi bi-graph-up text-brand text-2xl"></i>
            </div>
            <h1 class="h1 mb-sm">Technical Analysis</h1>
            <p class="text-secondary">Advanced technical indicators and chart patterns</p>
        </div>

        <!-- Search -->
        <div class="card mb-xl">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-search me-sm"></i>Analysis Settings
                </h3>
            </div>
            <form id="analysisForm" class="flex gap-md items-end flex-wrap">
                <div class="flex-1 min-w-[200px]">
                    <label for="stockCode" class="text-secondary mb-xs block">Stock Code</label>
                    <input type="text" id="stockCode" name="stockCode" class="input font-mono" placeholder="e.g. 2330"
                        maxlength="10" required>
                </div>

                <div class="flex-1 min-w-[200px]">
                    <label for="period" class="text-secondary mb-xs block">Period</label>
                    <select id="period" name="period" class="input">
                        <option value="5">5 Days</option>
                        <option value="20" selected>20 Days</option>
                        <option value="60">60 Days</option>
                        <option value="120">120 Days</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-graph-up me-sm"></i>Analyze
                </button>
            </form>
        </div>

        <!-- Analysis Grid -->
        <div class="grid grid-cols-3-lg gap-xl">

            <!-- Chart -->
            <div class="col-span-2-lg card">
                <div class="card-header">
                    <h3 class="card-title">Price Chart</h3>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="priceChart" style="display: none;"></canvas>
                    <div id="chartPlaceholder"
                        class="flex flex-col items-center justify-center h-full text-secondary opacity-50">
                        <i class="bi bi-graph-up text-4xl mb-md"></i>
                        <p>Enter stock code to start analysis</p>
                    </div>
                </div>
            </div>

            <!-- Indicators -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-speedometer2 me-sm"></i>Indicators
                    </h3>
                </div>
                <div id="indicators" class="flex flex-col gap-md">
                    <!-- RSI -->
                    <div class="p-md radius-md bg-surface border border-color flex justify-between items-center">
                        <span class="text-secondary">RSI (14)</span>
                        <span class="font-mono font-bold text-secondary" id="rsi">--</span>
                    </div>

                    <!-- MACD -->
                    <div class="p-md radius-md bg-surface border border-color flex justify-between items-center">
                        <span class="text-secondary">MACD</span>
                        <span class="font-mono font-bold text-secondary" id="macd">--</span>
                    </div>

                    <!-- Bollinger -->
                    <div class="p-md radius-md bg-surface border border-color flex justify-between items-center">
                        <span class="text-secondary">Bollinger</span>
                        <span class="font-mono font-bold text-secondary" id="bollinger">--</span>
                    </div>

                    <!-- KD -->
                    <div class="p-md radius-md bg-surface border border-color flex justify-between items-center">
                        <span class="text-secondary">KD</span>
                        <span class="font-mono font-bold text-secondary" id="kd">--</span>
                    </div>

                    <!-- MA20 -->
                    <div class="p-md radius-md bg-surface border border-color flex justify-between items-center">
                        <span class="text-secondary">MA20</span>
                        <span class="font-mono font-bold text-secondary" id="ma20">--</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let chart = null;

        // Chart Config
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'JetBrains Mono', monospace";

        document.getElementById('analysisForm').addEventListener('submit', function (e) {
            e.preventDefault();
            performTechnicalAnalysis();
        });

        function performTechnicalAnalysis() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) return;

            showLoading();

            setTimeout(() => {
                const mockData = generateMockAnalysis(stockCode);
                displayAnalysisResults(mockData);
                createChart(mockData.prices);
            }, 1000);
        }

        function showLoading() {
            document.getElementById('chartPlaceholder').innerHTML = `
                <div class="spinner-border text-brand mb-md" role="status"></div>
                <p>Analyzing...</p>
            `;
        }

        function generateMockAnalysis(stockCode) {
            const rsi = Math.random() * 100;
            const prices = [];
            let basePrice = 100 + Math.random() * 400;

            for (let i = 0; i < 30; i++) {
                basePrice += (Math.random() - 0.5) * 20;
                prices.push({
                    date: new Date(Date.now() - (29 - i) * 24 * 60 * 60 * 1000).toLocaleDateString(),
                    price: Math.max(50, basePrice + Math.random() * 10)
                });
            }

            return {
                stockCode,
                rsi: rsi.toFixed(2),
                macd: ((Math.random() - 0.5) * 10).toFixed(3),
                bollinger: Math.random() > 0.5 ? 'Upper' : 'Lower',
                kd: (Math.random() * 100).toFixed(2),
                ma20: (basePrice * (0.95 + Math.random() * 0.1)).toFixed(2),
                prices
            };
        }

        function displayAnalysisResults(data) {
            const rsiEl = document.getElementById('rsi');
            rsiEl.textContent = data.rsi;
            rsiEl.className = 'font-mono font-bold ' +
                (data.rsi > 70 ? 'text-down' : data.rsi < 30 ? 'text-up' : 'text-secondary');

            document.getElementById('macd').textContent = data.macd;
            document.getElementById('bollinger').textContent = data.bollinger;
            document.getElementById('kd').textContent = data.kd;
            document.getElementById('ma20').textContent = data.ma20;
        }

        function createChart(prices) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.map(p => p.date),
                    datasets: [{
                        label: 'Price',
                        data: prices.map(p => p.price),
                        borderColor: '#00E5FF',
                        backgroundColor: 'rgba(0, 229, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            document.getElementById('chartPlaceholder').style.display = 'none';
            document.getElementById('priceChart').style.display = 'block';
        }
    });
</script>
{% endblock %}