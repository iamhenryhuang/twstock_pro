{% extends "layouts/base.html" %}

{% block title %}Asset Allocation | TST{% endblock %}

{% block content %}
<section class="section">
    <div class="container">

        <!-- Header -->
        <div class="text-center mb-xl">
            <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-surface border border-brand mb-md">
                <i class="bi bi-pie-chart text-brand text-2xl"></i>
            </div>
            <h1 class="h1 mb-sm">Asset Allocation</h1>
            <p class="text-secondary">Optimize your portfolio based on risk tolerance and investment horizon</p>
        </div>

        <div class="grid grid-cols-2-md gap-xl">

            <!-- Parameters -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-sliders me-sm"></i>Investment Parameters
                    </h3>
                </div>
                <form id="allocationForm">
                    <div class="mb-lg">
                        <label for="totalAmount" class="text-secondary mb-xs block">Total Investment</label>
                        <div class="input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="number" id="totalAmount" class="input" placeholder="1000000" min="10000"
                                required>
                        </div>
                    </div>

                    <div class="mb-lg">
                        <label for="riskProfile" class="text-secondary mb-xs block">Risk Profile</label>
                        <select id="riskProfile" class="input" required>
                            <option value="conservative">Conservative (Low Risk)</option>
                            <option value="moderate">Moderate (Medium Risk)</option>
                            <option value="aggressive">Aggressive (High Risk)</option>
                        </select>
                    </div>

                    <div class="mb-xl">
                        <label for="investmentHorizon" class="text-secondary mb-xs block">Investment Horizon</label>
                        <select id="investmentHorizon" class="input" required>
                            <option value="short">Short Term (1-3 Years)</option>
                            <option value="medium">Medium Term (3-7 Years)</option>
                            <option value="long">Long Term (>7 Years)</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">
                        <i class="bi bi-pie-chart me-sm"></i>Generate Allocation
                    </button>
                </form>
            </div>

            <!-- Results -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-graph-up me-sm"></i>Recommended Allocation
                    </h3>
                </div>

                <div style="height: 300px; margin-bottom: var(--space-lg);">
                    <canvas id="allocationChart" style="display: none;"></canvas>
                    <div id="chartPlaceholder"
                        class="flex flex-col items-center justify-center h-full text-secondary opacity-50">
                        <i class="bi bi-pie-chart text-4xl mb-md"></i>
                        <p>Set parameters to see recommendation</p>
                    </div>
                </div>

                <div id="allocationResults" class="flex flex-col gap-md" style="display: none;">
                    <!-- Results injected here -->
                </div>
            </div>

        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let chart = null;

        // Chart Config
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'JetBrains Mono', monospace";

        document.getElementById('allocationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            generateAllocation();
        });

        function generateAllocation() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const riskProfile = document.getElementById('riskProfile').value;
            const horizon = document.getElementById('investmentHorizon').value;

            const allocations = getPortfolioAllocation(riskProfile, horizon);

            const allocatedAmounts = allocations.map(item => ({
                ...item,
                amount: Math.round(totalAmount * item.percentage / 100)
            }));

            displayAllocation(allocatedAmounts);
            createChart(allocatedAmounts);
        }

        function getPortfolioAllocation(risk, horizon) {
            const allocations = {
                conservative: [
                    { name: 'Large Cap Stocks', percentage: 25, color: '#00E5FF' },
                    { name: 'Bonds', percentage: 40, color: '#00C853' },
                    { name: 'Cash/Money Market', percentage: 20, color: '#FFD700' },
                    { name: 'Global Stocks', percentage: 15, color: '#7B68EE' }
                ],
                moderate: [
                    { name: 'Large Cap Stocks', percentage: 35, color: '#00E5FF' },
                    { name: 'Mid/Small Cap', percentage: 15, color: '#FF3D00' },
                    { name: 'Bonds', percentage: 25, color: '#00C853' },
                    { name: 'Global Stocks', percentage: 25, color: '#7B68EE' }
                ],
                aggressive: [
                    { name: 'Large Cap Stocks', percentage: 30, color: '#00E5FF' },
                    { name: 'Mid/Small Cap', percentage: 25, color: '#FF3D00' },
                    { name: 'Growth Funds', percentage: 20, color: '#FFD700' },
                    { name: 'Emerging Markets', percentage: 15, color: '#7B68EE' },
                    { name: 'Bonds', percentage: 10, color: '#00C853' }
                ]
            };

            return allocations[risk] || allocations.moderate;
        }

        function displayAllocation(allocations) {
            const resultsDiv = document.getElementById('allocationResults');

            resultsDiv.innerHTML = allocations.map(item => `
                <div class="p-md radius-md bg-surface border border-color flex justify-between items-center">
                    <div class="flex items-center gap-sm">
                        <div style="width: 12px; height: 12px; background: ${item.color}; border-radius: 2px;"></div>
                        <span class="text-secondary">${item.name}</span>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-white">${item.percentage}%</div>
                        <div class="font-mono text-sm text-secondary">NT$ ${item.amount.toLocaleString()}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('chartPlaceholder').style.display = 'none';
            resultsDiv.style.display = 'flex';
        }

        function createChart(allocations) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: allocations.map(item => item.name),
                    datasets: [{
                        data: allocations.map(item => item.percentage),
                        backgroundColor: allocations.map(item => item.color),
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    },
                    cutout: '70%'
                }
            });

            document.getElementById('allocationChart').style.display = 'block';
        }
    });
</script>
{% endblock %}