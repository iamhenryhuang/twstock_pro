{% extends "layouts/base.html" %}

{% block title %}è³‡ç”¢é…ç½® | TWStock Pro{% endblock %}

{% block extra_css %}
<style>
    .tool-page {
        padding: 2.5rem 0 5rem;
    }

    .tool-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .tool-icon-wrap {
        width: 52px;
        height: 52px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
    }

    .tool-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 1.5rem;
        align-items: start;
    }

    .form-group {
        margin-bottom: 1.125rem;
    }

    .form-group label {
        display: block;
        margin-bottom: .5rem;
        font-size: .8rem;
        font-weight: 600;
        color: var(--text-muted);
        letter-spacing: .06em;
        text-transform: uppercase;
    }

    .input-prefix-group {
        position: relative;
    }

    .input-prefix {
        position: absolute;
        left: .875rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: .875rem;
        pointer-events: none;
        font-family: var(--font-mono);
    }

    .has-prefix {
        padding-left: 2.5rem !important;
    }

    /* Risk cards */
    .risk-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: .625rem;
        margin-bottom: 1.25rem;
    }

    .risk-card {
        padding: .875rem .75rem;
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        cursor: pointer;
        text-align: center;
        transition: all var(--transition-fast);
        background: var(--bg-glass);
    }

    .risk-card:hover {
        border-color: var(--border-medium);
    }

    .risk-card.selected {
        border-color: var(--brand-cyan);
        background: rgba(0, 212, 255, .06);
    }

    .risk-card-icon {
        font-size: 1.5rem;
        display: block;
        margin-bottom: .375rem;
    }

    .risk-card-label {
        font-size: .7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .08em;
    }

    /* Allocation rows */
    .alloc-row {
        display: flex;
        align-items: center;
        gap: .875rem;
        padding: .75rem 0;
        border-bottom: 1px solid var(--border-subtle);
    }

    .alloc-row:last-child {
        border-bottom: none;
    }

    .alloc-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .alloc-name {
        font-size: .85rem;
        flex: 1;
        color: var(--text-secondary);
    }

    .alloc-bar-wrap {
        flex: 2;
        height: 6px;
        background: var(--bg-surface);
        border-radius: 3px;
        overflow: hidden;
    }

    .alloc-bar {
        height: 100%;
        border-radius: 3px;
        transition: width .6s cubic-bezier(.4, 0, .2, 1);
    }

    .alloc-pct {
        font-family: var(--font-mono);
        font-size: .85rem;
        font-weight: 600;
        width: 2.5rem;
        text-align: right;
    }

    .alloc-amt {
        font-family: var(--font-mono);
        font-size: .78rem;
        color: var(--text-muted);
        text-align: right;
        white-space: nowrap;
    }

    .chart-area {
        height: 280px;
        position: relative;
    }

    @media (max-width:768px) {
        .tool-layout {
            grid-template-columns: 1fr;
        }

        .risk-cards {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container tool-page">

    <div class="tool-header">
        <div class="tool-icon-wrap" style="background:rgba(0,212,255,.12);color:var(--brand-cyan);">
            <i class="bi bi-pie-chart-fill"></i>
        </div>
        <div>
            <h1 style="font-size:1.5rem;font-weight:800;margin:0 0 .25rem;">è³‡ç”¢é…ç½®å»ºè­°</h1>
            <p style="color:var(--text-secondary);font-size:.875rem;margin:0;">ä¾ç…§é¢¨éšªæ‰¿å—åº¦èˆ‡æŠ•è³‡æœŸé™ï¼Œç”Ÿæˆå€‹äººåŒ–çš„è³‡ç”¢é…ç½®å»ºè­°</p>
        </div>
    </div>

    <div class="tool-layout">

        <!-- Left: Inputs -->
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="bi bi-person-fill"
                        style="color:var(--brand-cyan);margin-right:.5rem;"></i>å€‹äººåŒ–è¨­å®š</span>
            </div>
            <div class="card-body">
                <form id="allocationForm">
                    <div class="form-group">
                        <label>ç¸½æŠ•è³‡é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                        <div class="input-prefix-group">
                            <span class="input-prefix">NT$</span>
                            <input type="number" id="totalAmount" class="input has-prefix"
                                style="font-family:var(--font-mono);" placeholder="1,000,000" min="0" value="1000000"
                                required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æŠ•è³‡æœŸé™</label>
                        <select id="investmentHorizon" class="input" required>
                            <option value="short">çŸ­æœŸï¼ˆ1-3 å¹´ï¼‰</option>
                            <option value="medium" selected>ä¸­æœŸï¼ˆ3-7 å¹´ï¼‰</option>
                            <option value="long">é•·æœŸï¼ˆ7 å¹´ä»¥ä¸Šï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>é¢¨éšªæ‰¿å—åº¦</label>
                        <div class="risk-cards" id="riskCards">
                            <div class="risk-card" data-val="conservative" onclick="selectRisk(this)">
                                <span class="risk-card-icon">ğŸ›¡ï¸</span>
                                <div class="risk-card-label" style="color:var(--brand-green);">ä¿å®ˆå‹</div>
                            </div>
                            <div class="risk-card selected" data-val="moderate" onclick="selectRisk(this)">
                                <span class="risk-card-icon">âš–ï¸</span>
                                <div class="risk-card-label" style="color:var(--brand-cyan);">ç©©å¥å‹</div>
                            </div>
                            <div class="risk-card" data-val="aggressive" onclick="selectRisk(this)">
                                <span class="risk-card-icon">ğŸš€</span>
                                <div class="risk-card-label" style="color:var(--brand-red);">ç©æ¥µå‹</div>
                            </div>
                        </div>
                        <input type="hidden" id="riskProfile" value="moderate">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;">
                        <i class="bi bi-pie-chart"></i> ç”Ÿæˆé…ç½®æ–¹æ¡ˆ
                    </button>
                </form>
            </div>
        </div>

        <!-- Right: Results -->
        <div>
            <div class="card" style="margin-bottom:1.25rem;">
                <div class="card-header">
                    <span class="card-title"><i class="bi bi-graph-up"
                            style="color:var(--brand-cyan);margin-right:.5rem;"></i>å»ºè­°é…ç½®åœ“é¤…åœ–</span>
                    <span id="profileLabel" style="font-size:.78rem;color:var(--text-muted);"></span>
                </div>
                <div style="padding:1.25rem;">
                    <div class="chart-area">
                        <canvas id="allocationChart" style="display:none;"></canvas>
                        <div id="chartPlaceholder"
                            style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;color:var(--text-muted);">
                            <i class="bi bi-pie-chart" style="font-size:3rem;opacity:.15;margin-bottom:1rem;"></i>
                            <p style="font-size:.875rem;">è¨­å®šåƒæ•¸å¾Œç”Ÿæˆé…ç½®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title"><i class="bi bi-list-check"
                            style="color:var(--brand-green);margin-right:.5rem;"></i>å„é¡è³‡ç”¢æ˜ç´°</span>
                    <span id="totalAmountLabel"
                        style="font-size:.78rem;color:var(--text-muted);font-family:var(--font-mono);"></span>
                </div>
                <div class="card-body" id="allocationResults" style="padding-top:.5rem;padding-bottom:.5rem;">
                    <div style="text-align:center;padding:2rem;color:var(--text-muted);font-size:.875rem;">
                        é»æ“Šã€Œç”Ÿæˆé…ç½®æ–¹æ¡ˆã€å¾Œé¡¯ç¤º
                    </div>
                </div>
            </div>

            <div
                style="margin-top:1rem;background:rgba(0,212,255,.04);border:1px solid rgba(0,212,255,.15);border-radius:var(--radius-md);padding:.875rem 1rem;font-size:.78rem;color:var(--brand-cyan);display:flex;gap:.5rem;align-items:flex-start;">
                <i class="bi bi-info-circle-fill" style="flex-shrink:0;margin-top:.1rem;"></i>
                <span>é…ç½®å»ºè­°åŸºæ–¼ä¸€èˆ¬å­¸è¡“ç†è«–ï¼ˆModern Portfolio Theoryï¼‰ï¼Œå¯¦éš›åŸ·è¡Œå‰è«‹è«®è©¢åˆæ ¼ç†è²¡è¦åŠƒå¸«ã€‚</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart = null;

    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
    Chart.defaults.font.family = "'JetBrains Mono', monospace";

    function selectRisk(el) {
        document.querySelectorAll('.risk-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('riskProfile').value = el.dataset.val;
    }

    document.getElementById('allocationForm').addEventListener('submit', function (e) {
        e.preventDefault();
        generateAllocation();
    });

    const allocations = {
        conservative: {
            label: 'ä¿å®ˆå‹',
            items: [
                { name: 'å¤§å‹è‚¡ï¼ˆå°è‚¡ï¼‰', pct: 20, color: '#00D4FF' },
                { name: 'å‚µåˆ¸ ETF', pct: 40, color: '#00E676' },
                { name: 'ç¾é‡‘ / è²¨å¹£åŸºé‡‘', pct: 25, color: '#FFD600' },
                { name: 'æµ·å¤–è‚¡ç¥¨ ETF', pct: 15, color: '#7B2FFF' }
            ]
        },
        moderate: {
            label: 'ç©©å¥å‹',
            items: [
                { name: 'å¤§å‹è‚¡ï¼ˆå°è‚¡ï¼‰', pct: 35, color: '#00D4FF' },
                { name: 'ä¸­å°å‹è‚¡ ETF', pct: 15, color: '#FF6D00' },
                { name: 'å‚µåˆ¸ ETF', pct: 25, color: '#00E676' },
                { name: 'æµ·å¤–è‚¡ç¥¨ ETF', pct: 25, color: '#7B2FFF' }
            ]
        },
        aggressive: {
            label: 'ç©æ¥µå‹',
            items: [
                { name: 'å¤§å‹ç§‘æŠ€è‚¡', pct: 30, color: '#00D4FF' },
                { name: 'ä¸­å°å‹æˆé•·è‚¡', pct: 25, color: '#FF6D00' },
                { name: 'æ–°èˆˆå¸‚å ´ ETF', pct: 20, color: '#7B2FFF' },
                { name: 'é«˜æˆé•·åŸºé‡‘', pct: 15, color: '#FFD600' },
                { name: 'å‚µåˆ¸ï¼ˆé˜²å®ˆï¼‰', pct: 10, color: '#00E676' }
            ]
        }
    };

    function fmtAmt(n) { return 'NT$ ' + Math.round(n).toLocaleString('zh-TW'); }

    function generateAllocation() {
        const total = parseFloat(document.getElementById('totalAmount').value) || 0;
        const risk = document.getElementById('riskProfile').value;
        const alloc = allocations[risk] || allocations.moderate;

        document.getElementById('profileLabel').textContent = alloc.label;
        document.getElementById('totalAmountLabel').textContent = `ç¸½è¨ˆ ${fmtAmt(total)}`;

        const items = alloc.items.map(item => ({ ...item, amount: total * item.pct / 100 }));

        // Update detail rows
        document.getElementById('allocationResults').innerHTML = items.map(item => `
        <div class="alloc-row">
            <div class="alloc-dot" style="background:${item.color};"></div>
            <div class="alloc-name">${item.name}</div>
            <div class="alloc-bar-wrap"><div class="alloc-bar" style="width:${item.pct}%;background:${item.color};opacity:.7;"></div></div>
            <div class="alloc-pct">${item.pct}%</div>
            <div class="alloc-amt">${fmtAmt(item.amount)}</div>
        </div>`).join('');

        // Update chart
        const ctx = document.getElementById('allocationChart').getContext('2d');
        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: items.map(i => i.name),
                datasets: [{
                    data: items.map(i => i.pct),
                    backgroundColor: items.map(i => i.color),
                    borderWidth: 0,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true, font: { size: 11 } } },
                    tooltip: { callbacks: { label: ctx => ` ${ctx.label}ï¼š${ctx.raw}%` } }
                },
                cutout: '72%'
            }
        });

        document.getElementById('chartPlaceholder').style.display = 'none';
        document.getElementById('allocationChart').style.display = 'block';
    }

    // Auto-calculate on load with default values
    document.addEventListener('DOMContentLoaded', generateAllocation);
</script>
{% endblock %}