{% extends "layouts/base.html" %}

{% block title %}Stock Screener | TST{% endblock %}

{% block content %}
<section class="section">
    <div class="container">

        <!-- Header -->
        <div class="text-center mb-xl">
            <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-surface border border-brand mb-md">
                <i class="bi bi-funnel text-brand text-2xl"></i>
            </div>
            <h1 class="h1 mb-sm">Stock Screener</h1>
            <p class="text-secondary">Filter stocks based on financial metrics and technical indicators</p>
        </div>

        <!-- Filters -->
        <div class="card mb-xl">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-sliders me-sm"></i>Filter Settings
                </h3>
            </div>
            <form id="screenerForm">
                <div class="grid grid-cols-3-md gap-lg mb-lg">
                    <div>
                        <label for="marketCap" class="text-secondary mb-xs block">Market Cap</label>
                        <select id="marketCap" class="input">
                            <option value="">Any</option>
                            <option value="large">Large Cap (>100B)</option>
                            <option value="mid">Mid Cap (10-100B)</option>
                            <option value="small">Small Cap (<10B)< /option>
                        </select>
                    </div>

                    <div>
                        <label for="peRatio" class="text-secondary mb-xs block">P/E Ratio</label>
                        <select id="peRatio" class="input">
                            <option value="">Any</option>
                            <option value="low">Undervalued (<15)< /option>
                            <option value="moderate">Fair (15-25)</option>
                            <option value="high">Growth (>25)</option>
                        </select>
                    </div>

                    <div>
                        <label for="dividendYield" class="text-secondary mb-xs block">Dividend Yield</label>
                        <select id="dividendYield" class="input">
                            <option value="">Any</option>
                            <option value="high">High (>4%)</option>
                            <option value="moderate">Moderate (2-4%)</option>
                            <option value="low">Low (<2%)< /option>
                        </select>
                    </div>

                    <div>
                        <label for="industry" class="text-secondary mb-xs block">Industry</label>
                        <select id="industry" class="input">
                            <option value="">Any</option>
                            <option value="tech">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="traditional">Traditional</option>
                            <option value="biotech">Biotech</option>
                        </select>
                    </div>

                    <div>
                        <label for="roe" class="text-secondary mb-xs block">ROE</label>
                        <select id="roe" class="input">
                            <option value="">Any</option>
                            <option value="excellent">Excellent (>20%)</option>
                            <option value="good">Good (15-20%)</option>
                            <option value="average">Average (10-15%)</option>
                        </select>
                    </div>

                    <div>
                        <label for="priceChange" class="text-secondary mb-xs block">Recent Performance</label>
                        <select id="priceChange" class="input">
                            <option value="">Any</option>
                            <option value="strong">Strong (>10%)</option>
                            <option value="stable">Stable (Â±5%)</option>
                            <option value="weak">Weak (<-10%)< /option>
                        </select>
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary px-xl">
                        <i class="bi bi-funnel me-sm"></i>Run Screen
                    </button>
                </div>
            </form>
        </div>

        <!-- Results -->
        <div class="card">
            <div class="card-header flex justify-between items-center">
                <h3 class="card-title">
                    <i class="bi bi-list-ul me-sm"></i>Results
                </h3>
                <div class="text-secondary text-sm" id="resultCount"></div>
            </div>

            <div id="resultsContainer">
                <div class="text-center py-xl">
                    <i class="bi bi-funnel text-secondary mb-md block" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="text-secondary">Set filters and click "Run Screen" to see results</p>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        document.getElementById('screenerForm').addEventListener('submit', function (e) {
            e.preventDefault();
            performScreening();
        });

        function performScreening() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = `
                <div class="text-center py-xl">
                    <div class="spinner-border text-brand mb-md" role="status"></div>
                    <p class="text-secondary">Screening stocks...</p>
                </div>
            `;

            // Mock API call
            setTimeout(() => {
                const mockStocks = generateMockResults();
                displayResults(mockStocks);
            }, 1500);
        }

        function generateMockResults() {
            const stockCodes = ['2330', '2317', '2454', '2882', '6505', '3008', '2303', '2474', '2412', '2308'];
            const stockNames = ['TSMC', 'Hon Hai', 'MediaTek', 'Cathay Fin', 'Formosa Petro', 'Largan', 'UMC', 'Catcher', 'Chunghwa Telecom', 'Delta'];

            return stockCodes.slice(0, 7).map((code, index) => {
                const price = 100 + Math.random() * 400;
                const change = (Math.random() - 0.5) * 20;
                const changePercent = (change / price * 100).toFixed(2);

                return {
                    code,
                    name: stockNames[index],
                    price: price.toFixed(2),
                    change: change.toFixed(2),
                    changePercent,
                    pe: (Math.random() * 30 + 5).toFixed(1),
                    dividend: (Math.random() * 6 + 1).toFixed(2),
                    roe: (Math.random() * 25 + 5).toFixed(1)
                };
            });
        }

        function displayResults(stocks) {
            const resultsContainer = document.getElementById('resultsContainer');
            document.getElementById('resultCount').textContent = `${stocks.length} matches found`;

            const tableHtml = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th class="text-right">Price</th>
                                <th class="text-right">Change</th>
                                <th class="text-right">Change %</th>
                                <th class="text-right">P/E</th>
                                <th class="text-right">Yield</th>
                                <th class="text-right">ROE</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map(stock => `
                                <tr style="cursor: pointer;" onclick="window.location.href='/stock?code=${stock.code}'">
                                    <td><span class="badge badge-brand font-mono">${stock.code}</span></td>
                                    <td>${stock.name}</td>
                                    <td class="text-right font-mono text-white">${stock.price}</td>
                                    <td class="text-right font-mono ${stock.change > 0 ? 'text-up' : stock.change < 0 ? 'text-down' : 'text-secondary'}">
                                        ${stock.change > 0 ? '+' : ''}${stock.change}
                                    </td>
                                    <td class="text-right font-mono ${stock.changePercent > 0 ? 'text-up' : stock.changePercent < 0 ? 'text-down' : 'text-secondary'}">
                                        ${stock.changePercent > 0 ? '+' : ''}${stock.changePercent}%
                                    </td>
                                    <td class="text-right font-mono text-secondary">${stock.pe}</td>
                                    <td class="text-right font-mono text-secondary">${stock.dividend}%</td>
                                    <td class="text-right font-mono text-secondary">${stock.roe}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            resultsContainer.innerHTML = tableHtml;
        }
    });
</script>
{% endblock %}