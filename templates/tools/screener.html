{% extends "layouts/base.html" %}

{% block title %}è‚¡ç¥¨ç¯©é¸å™¨ | TWStock Pro{% endblock %}

{% block extra_css %}
<style>
    .tool-page {
        padding: 2.5rem 0 5rem;
    }

    .tool-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .tool-icon-wrap {
        width: 52px;
        height: 52px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
    }

    .filters-card {
        margin-bottom: 1.5rem;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

    .filter-group label {
        display: block;
        margin-bottom: .4rem;
        font-size: .75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: var(--text-muted);
    }

    /* Results table */
    .results-table {
        width: 100%;
        border-collapse: collapse;
    }

    .results-table th {
        padding: .625rem 1rem;
        font-size: .68rem;
        font-weight: 700;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-subtle);
        text-align: left;
        white-space: nowrap;
    }

    .results-table td {
        padding: .875rem 1rem;
        border-bottom: 1px solid var(--border-subtle);
        font-size: .875rem;
        vertical-align: middle;
        transition: background var(--transition-fast);
    }

    .results-table tbody tr:hover td {
        background: var(--bg-glass);
        cursor: pointer;
    }

    .results-table tbody tr:last-child td {
        border-bottom: none;
    }

    .code-badge {
        display: inline-block;
        font-family: var(--font-mono);
        font-size: .75rem;
        font-weight: 600;
        padding: .15rem .5rem;
        background: rgba(0, 212, 255, .08);
        border: 1px solid rgba(0, 212, 255, .2);
        border-radius: 4px;
        color: var(--brand-cyan);
    }

    .price-cell {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    .text-up {
        color: var(--brand-green) !important;
    }

    .text-down {
        color: var(--brand-red) !important;
    }

    .results-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .result-count {
        font-size: .78rem;
        color: var(--text-secondary);
        background: var(--bg-glass);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-full);
        padding: .2rem .75rem;
    }

    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        gap: 1rem;
        color: var(--text-secondary);
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
    }

    .empty-state i {
        font-size: 3rem;
        color: var(--text-muted);
        opacity: .2;
        margin-bottom: 1rem;
    }

    /* Preset chips */
    .preset-chips {
        display: flex;
        gap: .5rem;
        flex-wrap: wrap;
        margin-bottom: 1.25rem;
    }

    .preset-chip {
        padding: .25rem .875rem;
        border-radius: var(--radius-full);
        font-size: .75rem;
        font-weight: 600;
        border: 1px solid var(--border-subtle);
        background: var(--bg-glass);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .preset-chip:hover {
        border-color: var(--border-brand);
        color: var(--brand-cyan);
        background: rgba(0, 212, 255, .06);
    }

    @media (max-width:768px) {
        .filter-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width:480px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container tool-page">

    <div class="tool-header">
        <div class="tool-icon-wrap" style="background:rgba(255,145,0,.12);color:var(--brand-orange);">
            <i class="bi bi-funnel-fill"></i>
        </div>
        <div>
            <h1 style="font-size:1.5rem;font-weight:800;margin:0 0 .25rem;">æ™ºæ…§é¸è‚¡ç¯©é¸å™¨</h1>
            <p style="color:var(--text-secondary);font-size:.875rem;margin:0;">ä¾ç…§è²¡å‹™æŒ‡æ¨™ã€ç”¢æ¥­é¡åˆ¥ã€æ®–åˆ©ç‡ç­‰æ¢ä»¶ç¯©é¸é©åˆçš„è‚¡ç¥¨</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="card filters-card">
        <div class="card-header">
            <span class="card-title"><i class="bi bi-sliders"
                    style="color:var(--brand-orange);margin-right:.5rem;"></i>ç¯©é¸æ¢ä»¶</span>
        </div>
        <div class="card-body">
            <!-- Preset chips -->
            <div style="margin-bottom:1rem;">
                <div
                    style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-bottom:.5rem;">
                    å¿«é€Ÿé è¨­ â–¸</div>
                <div class="preset-chips">
                    <div class="preset-chip" onclick="applyPreset('high_dividend')">ğŸ’° é«˜æ®–åˆ©ç‡</div>
                    <div class="preset-chip" onclick="applyPreset('value')">ğŸ“Š ä½æœ¬ç›Šæ¯”</div>
                    <div class="preset-chip" onclick="applyPreset('growth')">ğŸš€ é«˜æˆé•·</div>
                    <div class="preset-chip" onclick="applyPreset('large_cap')">ğŸ› å¤§å‹è‚¡</div>
                    <div class="preset-chip" onclick="applyPreset('finance')">ğŸ¦ é‡‘èè‚¡</div>
                </div>
            </div>

            <form id="screenerForm">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>å¸‚å€¼è¦æ¨¡</label>
                        <select id="marketCap" class="input">
                            <option value="">ä¸é™</option>
                            <option value="large">å¤§å‹è‚¡ï¼ˆ&gt;1000å„„ï¼‰</option>
                            <option value="mid">ä¸­å‹è‚¡ï¼ˆ100-1000å„„ï¼‰</option>
                            <option value="small">å°å‹è‚¡ï¼ˆ&lt;100å„„ï¼‰</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>æœ¬ç›Šæ¯”ï¼ˆP/Eï¼‰</label>
                        <select id="peRatio" class="input">
                            <option value="">ä¸é™</option>
                            <option value="low">ä½ä¼°ï¼ˆ&lt;15ï¼‰</option>
                            <option value="moderate">åˆç†ï¼ˆ15-25ï¼‰</option>
                            <option value="high">æˆé•·ï¼ˆ&gt;25ï¼‰</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>æ®–åˆ©ç‡</label>
                        <select id="dividendYield" class="input">
                            <option value="">ä¸é™</option>
                            <option value="high">é«˜æ®–åˆ©ç‡ï¼ˆ&gt;4%ï¼‰</option>
                            <option value="moderate">ä¸­æ®–åˆ©ç‡ï¼ˆ2-4%ï¼‰</option>
                            <option value="low">ä½æ®–åˆ©ç‡ï¼ˆ&lt;2%ï¼‰</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ç”¢æ¥­é¡åˆ¥</label>
                        <select id="industry" class="input">
                            <option value="">ä¸é™</option>
                            <option value="tech">é›»å­/ç§‘æŠ€</option>
                            <option value="finance">é‡‘è</option>
                            <option value="traditional">å‚³çµ±ç”¢æ¥­</option>
                            <option value="biotech">ç”ŸæŠ€é†«ç™‚</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>è‚¡æ±æ¬Šç›Šå ±é…¬ç‡ï¼ˆROEï¼‰</label>
                        <select id="roe" class="input">
                            <option value="">ä¸é™</option>
                            <option value="excellent">å„ªè‰¯ï¼ˆ&gt;20%ï¼‰</option>
                            <option value="good">è‰¯å¥½ï¼ˆ15-20%ï¼‰</option>
                            <option value="average">æ™®é€šï¼ˆ10-15%ï¼‰</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>è¿‘æœŸè¡¨ç¾</label>
                        <select id="priceChange" class="input">
                            <option value="">ä¸é™</option>
                            <option value="strong">å¼·å‹¢ï¼ˆ&gt;10%ï¼‰</option>
                            <option value="stable">ç©©å®šï¼ˆÂ±5%ï¼‰</option>
                            <option value="weak">å¼±å‹¢ï¼ˆ&lt;-10%ï¼‰</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel-fill"></i> é–‹å§‹ç¯©é¸
                    </button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="resetForm()">
                        <i class="bi bi-arrow-counterclockwise"></i> é‡è¨­æ¢ä»¶
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results -->
    <div class="card">
        <div class="card-header results-header">
            <span class="card-title"><i class="bi bi-list-ul"
                    style="color:var(--brand-orange);margin-right:.5rem;"></i>ç¯©é¸çµæœ</span>
            <span class="result-count" id="resultCount" style="display:none;"></span>
        </div>
        <div id="resultsContainer">
            <div class="empty-state">
                <i class="bi bi-funnel"></i>
                <p style="font-size:.9rem;color:var(--text-secondary);margin-bottom:.25rem;">è¨­å®šç¯©é¸æ¢ä»¶ä¸¦é»æ“Šã€Œé–‹å§‹ç¯©é¸ã€</p>
                <p style="font-size:.8rem;color:var(--text-muted);">æ”¯æ´ä¾å¸‚å€¼ã€P/Eã€æ®–åˆ©ç‡ã€ROE ç­‰å¤šé …æ¢ä»¶çµ„åˆç¯©é¸</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const presets = {
        high_dividend: { dividendYield: 'high', industry: '', peRatio: '', marketCap: '', roe: '', priceChange: '' },
        value: { peRatio: 'low', dividendYield: '', industry: '', marketCap: '', roe: 'good', priceChange: '' },
        growth: { roe: 'excellent', peRatio: 'high', dividendYield: '', industry: 'tech', marketCap: '', priceChange: 'strong' },
        large_cap: { marketCap: 'large', dividendYield: '', peRatio: '', industry: '', roe: '', priceChange: '' },
        finance: { industry: 'finance', dividendYield: 'high', marketCap: '', peRatio: '', roe: '', priceChange: '' }
    };

    function applyPreset(name) {
        const p = presets[name];
        if (!p) return;
        Object.keys(p).forEach(k => {
            const el = document.getElementById(k);
            if (el) el.value = p[k];
        });
        performScreening();
    }

    function resetForm() {
        document.getElementById('screenerForm').reset();
        document.getElementById('resultsContainer').innerHTML = `
        <div class="empty-state">
            <i class="bi bi-funnel" style="font-size:3rem;color:var(--text-muted);opacity:.2;margin-bottom:1rem;"></i>
            <p style="font-size:.9rem;color:var(--text-secondary);">è¨­å®šç¯©é¸æ¢ä»¶ä¸¦é»æ“Šã€Œé–‹å§‹ç¯©é¸ã€</p>
        </div>`;
        document.getElementById('resultCount').style.display = 'none';
    }

    document.getElementById('screenerForm').addEventListener('submit', function (e) {
        e.preventDefault();
        performScreening();
    });

    function performScreening() {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `
        <div class="loading-state">
            <div class="spinner"></div>
            <span>ç¯©é¸ä¸­ï¼Œè«‹ç¨å€™...</span>
        </div>`;
        document.getElementById('resultCount').style.display = 'none';

        const criteria = {
            marketCap: document.getElementById('marketCap').value,
            peRatio: document.getElementById('peRatio').value,
            dividendYield: document.getElementById('dividendYield').value,
            industry: document.getElementById('industry').value,
            roe: document.getElementById('roe').value,
            priceChange: document.getElementById('priceChange').value
        };

        fetch('/api/screener', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ criteria })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.results.length > 0) {
                    displayResults(data.results);
                } else if (data.results && data.results.length === 0) {
                    container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-search" style="font-size:3rem;color:var(--text-muted);opacity:.2;margin-bottom:1rem;"></i>
                    <p style="font-size:.9rem;color:var(--text-secondary);">æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</p>
                    <p style="font-size:.8rem;color:var(--text-muted);">è«‹å˜—è©¦æ”¾å¯¬ç¯©é¸æ¢ä»¶</p>
                </div>`;
                } else {
                    displayMockResults();
                }
            })
            .catch(() => displayMockResults());
    }

    function displayMockResults() {
        const stocks = [
            { code: '2330', name: 'å°ç©é›»', price: '918.00', change: 8.0, changePercent: 0.88, pe: 22.3, dividend: 2.8, roe: 26.5 },
            { code: '0056', name: 'å…ƒå¤§é«˜è‚¡æ¯', price: '38.50', change: 0.2, changePercent: 0.52, pe: 14.1, dividend: 5.2, roe: 12.4 },
            { code: '2882', name: 'åœ‹æ³°é‡‘', price: '51.20', change: -0.5, changePercent: -0.97, pe: 11.8, dividend: 4.9, roe: 9.8 },
            { code: '2412', name: 'ä¸­è¯é›»', price: '126.00', change: 0.5, changePercent: 0.40, pe: 23.5, dividend: 4.6, roe: 10.1 },
            { code: '2317', name: 'é´»æµ·', price: '105.50', change: 1.5, changePercent: 1.44, pe: 9.7, dividend: 3.9, roe: 8.7 },
        ];
        displayResults(stocks);
    }

    function displayResults(stocks) {
        const container = document.getElementById('resultsContainer');
        const count = document.getElementById('resultCount');
        count.textContent = `æ‰¾åˆ° ${stocks.length} æ”¯`;
        count.style.display = '';

        container.innerHTML = `
        <div class="table-container">
            <table class="results-table">
                <thead><tr>
                    <th>ä»£è™Ÿ</th><th>åç¨±</th>
                    <th style="text-align:right;">è‚¡åƒ¹</th>
                    <th style="text-align:right;">æ¼²è·Œ</th>
                    <th style="text-align:right;">æ¼²è·Œå¹…</th>
                    <th style="text-align:right;">P/E</th>
                    <th style="text-align:right;">æ®–åˆ©ç‡</th>
                    <th style="text-align:right;">ROE</th>
                </tr></thead>
                <tbody>
                    ${stocks.map(s => {
            const isUp = parseFloat(s.change) > 0;
            const chgCls = isUp ? 'text-up' : parseFloat(s.change) < 0 ? 'text-down' : '';
            const chgPre = isUp ? '+' : '';
            return `
                        <tr onclick="window.location.href='/stock?code=${s.code}'">
                            <td><span class="code-badge">${s.code}</span></td>
                            <td style="font-weight:600;">${s.name}</td>
                            <td class="price-cell" style="text-align:right;">NT$${s.price || s.current_price || 'â€”'}</td>
                            <td class="price-cell ${chgCls}" style="text-align:right;">${chgPre}${s.change}</td>
                            <td class="price-cell ${chgCls}" style="text-align:right;">${chgPre}${s.changePercent || s.change_percent || 0}%</td>
                            <td style="text-align:right;color:var(--text-secondary);font-family:var(--font-mono);">${s.pe || 'â€”'}</td>
                            <td style="text-align:right;color:var(--brand-green);font-family:var(--font-mono);">${s.dividend || s.dividend_yield || 'â€”'}%</td>
                            <td style="text-align:right;color:var(--brand-cyan);font-family:var(--font-mono);">${s.roe || 'â€”'}%</td>
                        </tr>`;
        }).join('')}
                </tbody>
            </table>
        </div>`;
    }
</script>
{% endblock %}