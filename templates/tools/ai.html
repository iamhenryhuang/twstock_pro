{% extends "layouts/base.html" %}

{% block title %}AI Price Prediction | TST{% endblock %}

{% block content %}
<section class="section">
  <div class="container">

    <!-- Header -->
    <div class="text-center mb-xl">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-surface border border-brand mb-md">
        <i class="bi bi-cpu-fill text-brand text-2xl"></i>
      </div>
      <h1 class="h1 mb-sm">AI Price Prediction</h1>
      <p class="text-secondary">Experimental price forecasting using statistical models</p>
    </div>

    <!-- Prediction Form -->
    <div class="card mb-xl" style="max-width: 800px; margin: 0 auto;">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-sliders me-sm"></i>Prediction Settings
        </h3>
      </div>
      <form onsubmit="event.preventDefault(); runPrediction();" class="grid grid-cols-3-md gap-lg items-end">
        <div>
          <label class="text-secondary mb-xs block">Stock Code</label>
          <input id="ai-code" type="text" class="input font-mono" placeholder="e.g. 2330" required />
        </div>
        <div>
          <label class="text-secondary mb-xs block">Forecast Days (1-180)</label>
          <input id="ai-days" type="number" min="1" max="180" value="30" class="input font-mono" />
        </div>
        <div>
          <button class="btn btn-primary w-full" type="submit">
            <i class="bi bi-play-circle me-sm"></i>Generate
          </button>
        </div>
      </form>
    </div>

    <!-- Results -->
    <div class="grid grid-cols-3-md gap-lg mb-xl">
      <div class="card text-center">
        <div class="text-secondary text-sm uppercase font-mono mb-xs">Last Close</div>
        <div class="h2 font-mono mb-0" id="ai-last">--</div>
      </div>
      <div class="card text-center">
        <div class="text-secondary text-sm uppercase font-mono mb-xs">Forecast End</div>
        <div class="h2 font-mono mb-0 text-brand" id="ai-forecast-end">--</div>
      </div>
      <div class="card text-center">
        <div class="text-secondary text-sm uppercase font-mono mb-xs">Expected Change</div>
        <div class="h2 font-mono mb-0" id="ai-forecast-change">--</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Forecast Chart</h3>
      </div>
      <div style="height: 400px; position: relative;">
        <canvas id="aiChart"></canvas>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let aiChart = null;

  // Chart Config
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = '#334155';
  Chart.defaults.font.family = "'JetBrains Mono', monospace";

  async function runPrediction() {
    const code = document.getElementById('ai-code').value.trim();
    const days = +document.getElementById('ai-days').value || 30;

    if (!code) return;

    const baseDays = Math.min(180, Math.max(days, 30));

    try {
      const res = await fetch(`/api/stock/${code}/chart?days=${baseDays}`);
      const data = await res.json();

      if (!data.success || !data.data || data.data.length < 5) {
        alert('Insufficient data');
        return;
      }

      const labels = data.data.map(x => x.time);
      const prices = data.data.map(x => x.price);

      // Simple Log-Linear Regression
      const ln = prices.map(p => Math.log(p));
      const n = ln.length;
      const xs = [...Array(n).keys()];
      const meanX = xs.reduce((a, b) => a + b, 0) / n;
      const meanY = ln.reduce((a, b) => a + b, 0) / n;

      let num = 0, den = 0;
      for (let i = 0; i < n; i++) {
        num += (xs[i] - meanX) * (ln[i] - meanY);
        den += (xs[i] - meanX) * (xs[i] - meanX);
      }

      const slope = den === 0 ? 0 : num / den;
      const intercept = meanY - slope * meanX;
      const fitted = xs.map(x => intercept + slope * x);
      const residuals = ln.map((y, i) => y - fitted[i]);
      const std = Math.sqrt(residuals.reduce((a, b) => a + b * b, 0) / Math.max(1, n - 2));

      const futureLabels = [];
      const futurePrices = [];

      for (let i = 1; i <= days; i++) {
        const x = n - 1 + i;
        const y = intercept + slope * x;
        futureLabels.push(`+${i}d`);
        futurePrices.push(Math.exp(y));
      }

      const allLabels = labels.concat(futureLabels);
      const last = prices[prices.length - 1];
      const end = futurePrices[futurePrices.length - 1];
      const change = last > 0 ? ((end / last - 1) * 100) : 0;

      document.getElementById('ai-last').textContent = last.toFixed(2);
      document.getElementById('ai-forecast-end').textContent = end.toFixed(2);

      const changeEl = document.getElementById('ai-forecast-change');
      changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
      changeEl.className = `h2 font-mono mb-0 ${change >= 0 ? 'text-up' : 'text-down'}`;

      const upper = allLabels.map((_, idx) => idx < labels.length ? null : futurePrices[idx - labels.length] * Math.exp(std));
      const lower = allLabels.map((_, idx) => idx < labels.length ? null : futurePrices[idx - labels.length] / Math.exp(std));

      renderChart(allLabels, prices, futurePrices, upper, lower, labels.length);

    } catch (e) {
      console.error(e);
      alert('Error fetching data');
    }
  }

  function renderChart(labels, hist, forecast, upper, lower, split) {
    const ctx = document.getElementById('aiChart').getContext('2d');
    if (aiChart) aiChart.destroy();

    const all = hist.concat(forecast);

    aiChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Historical',
            data: labels.map((_, i) => i < split ? all[i] : null),
            borderColor: '#94a3b8',
            backgroundColor: 'rgba(148, 163, 184, 0.1)',
            tension: 0.4,
            pointRadius: 0
          },
          {
            label: 'Forecast',
            data: labels.map((_, i) => i >= split ? all[i] : null),
            borderColor: '#00E5FF',
            backgroundColor: 'rgba(0, 229, 255, 0.1)',
            tension: 0.4,
            pointRadius: 0
          },
          {
            label: 'Upper Bound',
            data: upper,
            borderColor: 'rgba(0, 200, 83, 0.5)',
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
          },
          {
            label: 'Lower Bound',
            data: lower,
            borderColor: 'rgba(255, 23, 68, 0.5)',
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: 'rgba(255, 255, 255, 0.05)' } }
        }
      }
    });
  }
</script>
{% endblock %}