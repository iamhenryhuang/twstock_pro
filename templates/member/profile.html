{% extends "layouts/base.html" %}

{% block title %}Profile | TST{% endblock %}

{% block content %}
<section class="section">
    <div class="container">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="mb-lg p-md radius-md"
            style="background: {% if category == 'error' %}rgba(239, 68, 68, 0.1){% else %}rgba(34, 197, 94, 0.1){% endif %}; border: 1px solid {% if category == 'error' %}var(--color-danger){% else %}var(--color-success){% endif %}; color: {% if category == 'error' %}var(--color-danger){% else %}var(--color-success){% endif %};">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: var(--space-xl);">

            <!-- Profile Edit -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-person-circle me-sm"></i>Profile Settings
                    </h3>
                </div>
                <form method="POST">
                    {{ form.hidden_tag() }}

                    <div class="grid grid-cols-2 gap-lg mb-lg">
                        <div>
                            <label class="text-secondary mb-xs block">Username</label>
                            <input type="text" class="input bg-surface" value="{{ current_user.username }}" readonly>
                            <div class="text-secondary text-xs mt-xs">Cannot be changed</div>
                        </div>

                        <div>
                            {{ form.email.label(class="text-secondary mb-xs block") }}
                            {{ form.email(class="input" + (" border-danger" if form.email.errors else "")) }}
                            {% if form.email.errors %}
                            <div class="text-down text-sm mt-xs">
                                {% for error in form.email.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-lg mb-lg">
                        <div>
                            {{ form.full_name.label(class="text-secondary mb-xs block") }}
                            {{ form.full_name(class="input", placeholder="Full Name") }}
                        </div>

                        <div>
                            {{ form.phone.label(class="text-secondary mb-xs block") }}
                            {{ form.phone(class="input", placeholder="Phone Number") }}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-lg mb-lg">
                        <div>
                            <label class="text-secondary mb-xs block">Membership</label>
                            <div class="input-group">
                                <input type="text" class="input bg-surface"
                                    value="{% if current_user.is_vip() %}VIP Member{% elif current_user.is_premium() %}Pro Member{% else %}Free Member{% endif %}"
                                    readonly>
                                {% if current_user.is_vip() %}
                                <span class="input-group-text bg-warning text-black font-bold">VIP</span>
                                {% elif current_user.is_premium() %}
                                <span class="input-group-text bg-brand text-white font-bold">PRO</span>
                                {% else %}
                                <span class="input-group-text bg-surface text-secondary">FREE</span>
                                {% endif %}
                            </div>
                        </div>

                        <div>
                            <label class="text-secondary mb-xs block">Joined</label>
                            <input type="text" class="input bg-surface"
                                value="{{ current_user.created_at.strftime('%Y-%m-%d %H:%M') }}" readonly>
                        </div>
                    </div>

                    <div class="mb-xl">
                        <label class="text-secondary mb-xs block">Last Login</label>
                        <input type="text" class="input bg-surface"
                            value="{% if current_user.last_login %}{{ current_user.last_login.strftime('%Y-%m-%d %H:%M') }}{% else %}Never{% endif %}"
                            readonly>
                    </div>

                    <div class="flex justify-between items-center">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('change_password') }}" class="btn btn-outline">
                            <i class="bi bi-key me-sm"></i>Change Password
                        </a>
                    </div>
                </form>
            </div>

            <!-- Account Info -->
            <div class="flex flex-col gap-xl">

                <!-- Status Card -->
                <div class="card text-center">
                    <div class="card-header">
                        <h3 class="card-title justify-center">Membership Status</h3>
                    </div>
                    <div class="py-lg">
                        {% if current_user.is_vip() %}
                        <i class="bi bi-gem text-warning mb-md block" style="font-size: 3rem;"></i>
                        <h4 class="h3 text-warning mb-sm">VIP Member</h4>
                        <p class="text-secondary text-sm">Highest tier access</p>
                        {% elif current_user.is_premium() %}
                        <i class="bi bi-star-fill text-brand mb-md block" style="font-size: 3rem;"></i>
                        <h4 class="h3 text-brand mb-sm">Pro Member</h4>
                        <p class="text-secondary text-sm">Advanced features unlocked</p>
                        {% else %}
                        <i class="bi bi-person text-secondary mb-md block" style="font-size: 3rem;"></i>
                        <h4 class="h3 text-secondary mb-sm">Free Member</h4>
                        <p class="text-secondary text-sm mb-md">Basic access</p>
                        <button class="btn btn-sm btn-primary">Upgrade Now</button>
                        {% endif %}
                    </div>
                </div>

                <!-- Stats Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Usage Stats</h3>
                    </div>
                    <div class="flex flex-col gap-md">
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">Watchlist Items</span>
                            <span class="font-mono font-bold">{{ current_user.watchlists|length }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">Search History</span>
                            <span class="font-mono font-bold">{{ current_user.search_history|length }}</span>
                        </div>
                        {% if current_user.is_premium() %}
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">Price Alerts</span>
                            <span class="font-mono font-bold">{{ current_user.price_alerts|length }}</span>
                        </div>
                        {% endif %}

                        <div style="height: 1px; background: var(--border-color); margin: var(--space-sm) 0;"></div>

                        {% set features = current_user.get_membership_features() %}
                        <div class="text-sm text-secondary flex flex-col gap-sm">
                            <div class="flex items-center gap-sm">
                                <i class="bi bi-bookmark-star text-warning"></i>
                                <span>Limit: {% if features.watchlist_limit %}{{ features.watchlist_limit }}{% else
                                    %}Unlimited{% endif %}</span>
                            </div>
                            <div class="flex items-center gap-sm">
                                <i class="bi bi-clock-history text-info"></i>
                                <span>History: {% if features.history_days %}{{ features.history_days }} Days{% else
                                    %}Unlimited{% endif %}</span>
                            </div>
                            {% if features.price_alerts %}
                            <div class="flex items-center gap-sm">
                                <i class="bi bi-bell text-brand"></i>
                                <span>Alerts: Active</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
{% endblock %}