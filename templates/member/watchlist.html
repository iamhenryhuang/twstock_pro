{% extends "layouts/base.html" %}

{% block title %}自選股清單 | TWStock Pro{% endblock %}

{% block extra_css %}
<style>
    .watchlist-page {
        padding: 2.5rem 0 4rem;
    }

    .wl-table {
        width: 100%;
        border-collapse: collapse;
    }

    .wl-table th {
        padding: 9px 16px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--t-muted);
        border-bottom: 1px solid var(--b-default);
        white-space: nowrap;
    }

    .wl-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--b-default);
        font-size: 13px;
        color: var(--t-primary);
        transition: background var(--ease);
        vertical-align: middle;
    }

    .wl-table tbody tr:hover td {
        background: var(--bg-hover);
    }

    .wl-table tbody tr:last-child td {
        border-bottom: none;
    }

    .stock-code-link {
        display: inline-block;
        font-family: var(--mono);
        font-size: var(--text-xs);
        font-weight: 700;
        padding: 2px 8px;
        background: rgba(59, 130, 246, 0.08);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 5px;
        color: var(--c-blue);
        text-decoration: none;
        transition: all var(--ease);
    }

    .stock-code-link:hover {
        background: rgba(59, 130, 246, 0.15);
    }

    .stock-name-link {
        color: var(--t-primary);
        text-decoration: none;
        font-weight: 600;
        transition: color var(--ease);
    }

    .stock-name-link:hover {
        color: var(--c-blue);
    }

    .price-cell {
        font-family: var(--mono);
        font-weight: 500;
    }

    .date-cell {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--t-muted);
    }

    .notes-cell {
        font-size: 12px;
        color: var(--t-secondary);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .empty-state {
        text-align: center;
        padding: 72px 2rem;
    }

    .empty-icon {
        font-size: 52px;
        color: var(--t-muted);
        opacity: 0.2;
        margin-bottom: 16px;
        display: block;
    }

    .modal-search-list {
        max-height: 280px;
        overflow-y: auto;
        border: 1px solid var(--b-default);
        border-radius: var(--r-md);
        margin-top: 10px;
    }

    .search-result-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        border-bottom: 1px solid var(--b-default);
        cursor: pointer;
        transition: background var(--ease);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: var(--bg-hover);
    }

    .limit-banner {
        background: rgba(245, 158, 11, 0.08);
        border: 1px solid rgba(245, 158, 11, 0.25);
        border-radius: var(--r-md);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--c-gold);
        margin-bottom: 20px;
    }

    @media (max-width:768px) {

        .wl-table th:nth-child(4),
        .wl-table td:nth-child(4),
        .wl-table th:nth-child(5),
        .wl-table td:nth-child(5) {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container watchlist-page">
    <div class="flex items-center justify-between mb-6" style="flex-wrap:wrap;gap:12px;">
        <div>
            <h1
                style="font-size:var(--text-xl);font-weight:800;color:var(--t-white);display:flex;align-items:center;gap:10px;">
                <i class="bi bi-bookmark-star-fill" style="color:var(--c-blue);"></i> 自選股清單
            </h1>
            <p style="color:var(--t-secondary);font-size:13px;margin-top:6px;">
                正在追蹤 <strong style="color:var(--t-white);">{{ watchlist|length }}</strong> 支股票
                {% if features.watchlist_limit %}/ 上限 {{ features.watchlist_limit }} 支{% else %}（無上限）{% endif %}
            </p>
        </div>
        <button class="btn btn-primary" id="openAddModal">
            <i class="bi bi-plus-lg"></i> 新增股票
        </button>
    </div>

    {% if features.watchlist_limit and watchlist|length >= features.watchlist_limit %}
    <div class="limit-banner">
        <i class="bi bi-exclamation-triangle-fill" style="flex-shrink:0;"></i>
        <div>您已達到免費版自選股上限（{{ features.watchlist_limit }} 支）。<a href="#"
                style="color:var(--c-gold);font-weight:600;text-decoration:none;">升級 Pro</a> 可追蹤最多 100 支。</div>
    </div>
    {% endif %}

    <div class="card">
        {% if watchlist %}
        <div class="table-scroll">
            <table class="wl-table">
                <thead>
                    <tr>
                        <th>代號</th>
                        <th>股票名稱</th>
                        <th>加入時股價</th>
                        <th>加入日期</th>
                        <th>備註</th>
                        <th style="text-align:right;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in watchlist %}
                    <tr>
                        <td><a href="{{ url_for('stock_page', code=item.stock_code) }}" class="stock-code-link">{{
                                item.stock_code }}</a></td>
                        <td><a href="{{ url_for('stock_page', code=item.stock_code) }}" class="stock-name-link">{{
                                item.stock_name or '—' }}</a></td>
                        <td class="price-cell">{% if item.added_price %}NT$ {{ '%.2f'|format(item.added_price) }}{% else
                            %}<span style="color:var(--t-muted);">—</span>{% endif %}</td>
                        <td class="date-cell">{{ item.created_at.strftime('%Y-%m-%d') if item.created_at else '—' }}
                        </td>
                        <td class="notes-cell" title="{{ item.notes or '' }}">{{ item.notes or '—' }}</td>
                        <td style="text-align:right;white-space:nowrap;">
                            <a href="{{ url_for('stock_page', code=item.stock_code) }}" class="btn btn-outline btn-sm"
                                style="margin-right:4px;"><i class="bi bi-eye"></i></a>
                            <a href="{{ url_for('remove_from_watchlist_by_code', stock_code=item.stock_code) }}"
                                class="btn btn-danger btn-sm"
                                onclick="return confirm('確定移除 {{ item.stock_code }} 從自選股？')"><i
                                    class="bi bi-trash3"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-bookmark-plus empty-icon"></i>
            <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">自選股清單是空的</h3>
            <p style="color:var(--t-secondary);margin-bottom:24px;font-size:13px;">新增你感興趣的股票，隨時追蹤行情</p>
            <button class="btn btn-primary" id="openAddModal2"><i class="bi bi-plus-lg"></i> 新增第一支股票</button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Watchlist Modal -->
<div class="modal fade" id="addWatchlistModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{{ url_for('add_to_watchlist') }}" method="POST" id="addForm">
                <div class="modal-header">
                    <h5 style="font-weight:700;display:flex;align-items:center;gap:0.5rem;">
                        <i class="bi bi-bookmark-plus-fill" style="color:var(--brand-cyan);"></i>
                        新增自選股
                    </h5>
                    <button type="button" data-bs-dismiss="modal"
                        style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.2rem;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding:1.5rem;">
                    <div class="form-group" style="margin-bottom:1rem;">
                        <label for="modal-search">搜尋股票代號 / 名稱</label>
                        <div class="input-group" style="margin-top:0.5rem;">
                            <input type="text" class="input" id="modal-search" placeholder="輸入代號（如 2330）或名稱..."
                                autocomplete="off">
                        </div>
                        <div id="modal-search-results" class="modal-search-list" style="display:none;"></div>
                    </div>

                    <input type="hidden" name="stock_code" id="selected-stock-code">
                    <div id="selected-stock-display" style="display:none;margin-bottom:12px;">
                        <div
                            style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.2);border-radius:var(--r-md);">
                            <i class="bi bi-check-circle-fill" style="color:var(--c-green);"></i>
                            <span id="selected-stock-text" style="font-weight:600;"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="watchlist-notes">備註 <span
                                style="color:var(--t-muted);font-weight:400;font-size:var(--text-xs);">（選填）</span></label>
                        <textarea class="form-input" name="notes" id="watchlist-notes" rows="2"
                            placeholder="投資理由、目標價格等..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline btn-sm" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary btn-sm" id="submitBtn" disabled>
                        <i class="bi bi-bookmark-plus-fill"></i> 加入自選股
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('modal-search');
    const resultsDiv = document.getElementById('modal-search-results');
    const selectedCode = document.getElementById('selected-stock-code');
    const selectedDisplay = document.getElementById('selected-stock-display');
    const selectedText = document.getElementById('selected-stock-text');
    const submitBtn = document.getElementById('submitBtn');

    let debounceTimer;

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const q = searchInput.value.trim();
        if (q.length < 1) {
            resultsDiv.style.display = 'none';
            return;
        }
        debounceTimer = setTimeout(() => searchStocks(q), 350);
    });

    function searchStocks(q) {
        fetch(`/api/search?q=${encodeURIComponent(q)}&limit=10`)
            .then(r => r.json())
            .then(data => {
                if (!data.results || data.results.length === 0) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div style="padding:14px;text-align:center;color:var(--t-muted);font-size:13px;">找不到符合的股票</div>`;
                    return;
                }
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = data.results.map(s => `
                    <div class="search-result-item" onclick="selectStock('${s.code}', '${s.name}')">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-family:var(--mono);font-size:var(--text-xs);font-weight:700;
                                         padding:2px 7px;background:rgba(59,130,246,0.08);
                                         border:1px solid rgba(59,130,246,0.2);border-radius:4px;color:var(--c-blue);">
                                ${s.code}
                            </span>
                            <span style="font-size:13px;color:var(--t-primary);">${s.name}</span>
                        </div>
                        <i class="bi bi-plus-circle" style="color:var(--t-muted);"></i>
                    </div>
                `).join('');
            })
            .catch(() => { resultsDiv.style.display = 'none'; });
    }

    function selectStock(code, name) {
        selectedCode.value = code;
        selectedText.textContent = `${name} (${code})`;
        selectedDisplay.style.display = 'block';
        resultsDiv.style.display = 'none';
        searchInput.value = '';
        submitBtn.disabled = false;
    }

    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); const v = searchInput.value.trim(); if (v.length >= 4) selectStock(v, v); }
    });

    // Open modal handlers
    const modal = document.getElementById('addWatchlistModal');
    ['openAddModal', 'openAddModal2'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', () => { modal.style.display = 'flex'; modal.classList.add('show'); });
    });
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(el => {
        el.addEventListener('click', () => { modal.style.display = 'none'; modal.classList.remove('show'); });
    });
</script>
{% endblock %}