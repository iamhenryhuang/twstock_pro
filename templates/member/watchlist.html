{% extends "layouts/base.html" %}

{% block title %}自選股清單 | TWStock Pro{% endblock %}

{% block extra_css %}
<style>
    .watchlist-page {
        padding: 2.5rem 0 4rem;
    }

    .page-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    /* Watchlist table */
    .watchlist-card {
        overflow: hidden;
    }

    .wl-table {
        width: 100%;
        border-collapse: collapse;
    }

    .wl-table th {
        padding: 0.75rem 1.25rem;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-subtle);
        white-space: nowrap;
    }

    .wl-table td {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-subtle);
        font-size: 0.9rem;
        color: var(--text-primary);
        transition: background var(--transition-fast);
        vertical-align: middle;
    }

    .wl-table tbody tr:hover td {
        background: var(--bg-glass);
    }

    .wl-table tbody tr:last-child td {
        border-bottom: none;
    }

    .stock-code-link {
        display: inline-block;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.2rem 0.6rem;
        background: rgba(0, 212, 255, 0.08);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: var(--radius-sm);
        color: var(--brand-cyan);
        text-decoration: none;
        transition: all var(--transition-fast);
    }

    .stock-code-link:hover {
        background: rgba(0, 212, 255, 0.15);
        border-color: var(--border-brand);
    }

    .stock-name-link {
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 600;
        transition: color var(--transition-fast);
    }

    .stock-name-link:hover {
        color: var(--brand-cyan);
    }

    .price-cell {
        font-family: var(--font-mono);
        font-weight: 500;
    }

    .change-up {
        color: var(--brand-green);
    }

    .change-down {
        color: var(--brand-red);
    }

    .date-cell {
        font-family: var(--font-mono);
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .notes-cell {
        font-size: 0.8rem;
        color: var(--text-secondary);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--text-muted);
        opacity: 0.25;
        margin-bottom: 1.5rem;
        display: block;
    }

    /* Add modal search */
    .modal-search-list {
        max-height: 280px;
        overflow-y: auto;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        margin-top: 0.75rem;
    }

    .search-result-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: background var(--transition-fast);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: var(--bg-glass);
    }

    .limit-banner {
        background: rgba(255, 214, 0, 0.08);
        border: 1px solid rgba(255, 214, 0, 0.2);
        border-radius: var(--radius-md);
        padding: 0.875rem 1.125rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: var(--brand-gold);
        margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {

        .wl-table th:nth-child(4),
        .wl-table td:nth-child(4),
        .wl-table th:nth-child(5),
        .wl-table td:nth-child(5) {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container watchlist-page">

    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="bi bi-bookmark-star-fill" style="color:var(--brand-cyan);font-size:1.5rem;"></i>
                自選股清單
            </h1>
            <p style="color:var(--text-secondary);font-size:0.875rem;margin-top:0.375rem;">
                正在追蹤 <strong style="color:var(--text-primary);">{{ watchlist|length }}</strong> 支股票
                {% if features.watchlist_limit %}
                / 上限 {{ features.watchlist_limit }} 支
                {% else %}
                （無上限）
                {% endif %}
            </p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWatchlistModal">
            <i class="bi bi-plus-lg"></i> 新增股票
        </button>
    </div>

    <!-- Limit warning -->
    {% if features.watchlist_limit and watchlist|length >= features.watchlist_limit %}
    <div class="limit-banner">
        <i class="bi bi-exclamation-triangle-fill" style="font-size:1.1rem;flex-shrink:0;"></i>
        <div>
            您已達到免費版自選股上限（{{ features.watchlist_limit }} 支）。
            <a href="#" style="color:var(--brand-gold);font-weight:600;text-decoration:none;">升級 Pro 方案</a> 可追蹤最多 100
            支股票。
        </div>
    </div>
    {% endif %}

    <!-- Watchlist Table -->
    <div class="card watchlist-card">
        {% if watchlist %}
        <div class="table-container">
            <table class="wl-table">
                <thead>
                    <tr>
                        <th>代號</th>
                        <th>股票名稱</th>
                        <th>加入時股價</th>
                        <th>加入日期</th>
                        <th>備註</th>
                        <th style="text-align:right;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in watchlist %}
                    <tr>
                        <td>
                            <a href="{{ url_for('stock_page', code=item.stock_code) }}" class="stock-code-link">
                                {{ item.stock_code }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ url_for('stock_page', code=item.stock_code) }}" class="stock-name-link">
                                {{ item.stock_name or '—' }}
                            </a>
                        </td>
                        <td class="price-cell">
                            {% if item.added_price %}
                            NT$ {{ '%.2f'|format(item.added_price) }}
                            {% else %}
                            <span style="color:var(--text-muted);">—</span>
                            {% endif %}
                        </td>
                        <td class="date-cell">
                            {{ item.created_at.strftime('%Y-%m-%d') if item.created_at else '—' }}
                        </td>
                        <td class="notes-cell" title="{{ item.notes or '' }}">
                            {{ item.notes or '—' }}
                        </td>
                        <td style="text-align:right;white-space:nowrap;">
                            <a href="{{ url_for('stock_page', code=item.stock_code) }}" class="btn btn-outline btn-sm"
                                style="margin-right:0.375rem;">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ url_for('remove_from_watchlist_by_code', stock_code=item.stock_code) }}"
                                class="btn btn-danger btn-sm"
                                onclick="return confirm('確定移除 {{ item.stock_code }} 從自選股？')">
                                <i class="bi bi-trash3"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-bookmark-plus empty-icon"></i>
            <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem;">你的自選股是空的</h3>
            <p style="color:var(--text-secondary);margin-bottom:2rem;font-size:0.9rem;">
                新增你感興趣的股票，隨時追蹤行情
            </p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWatchlistModal">
                <i class="bi bi-plus-lg"></i> 新增第一支股票
            </button>
        </div>
        {% endif %}
    </div>

</div>

<!-- Add Watchlist Modal -->
<div class="modal fade" id="addWatchlistModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{{ url_for('add_to_watchlist') }}" method="POST" id="addForm">
                <div class="modal-header">
                    <h5 style="font-weight:700;display:flex;align-items:center;gap:0.5rem;">
                        <i class="bi bi-bookmark-plus-fill" style="color:var(--brand-cyan);"></i>
                        新增自選股
                    </h5>
                    <button type="button" data-bs-dismiss="modal"
                        style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.2rem;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="modal-body" style="padding:1.5rem;">
                    <div class="form-group" style="margin-bottom:1rem;">
                        <label for="modal-search">搜尋股票代號 / 名稱</label>
                        <div class="input-group" style="margin-top:0.5rem;">
                            <input type="text" class="input" id="modal-search" placeholder="輸入代號（如 2330）或名稱..."
                                autocomplete="off">
                        </div>
                        <div id="modal-search-results" class="modal-search-list" style="display:none;"></div>
                    </div>

                    <input type="hidden" name="stock_code" id="selected-stock-code">
                    <div id="selected-stock-display" style="display:none;margin-bottom:1rem;">
                        <div
                            style="display:flex;align-items:center;gap:0.625rem;padding:0.75rem;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.2);border-radius:var(--radius-md);">
                            <i class="bi bi-check-circle-fill" style="color:var(--brand-green);"></i>
                            <span id="selected-stock-text" style="font-weight:600;"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="watchlist-notes">備註 <span
                                style="color:var(--text-muted);font-weight:400;font-size:0.8rem;">（選填）</span></label>
                        <textarea class="input" name="notes" id="watchlist-notes" rows="2"
                            placeholder="投資理由、目標價格等..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline btn-sm" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary btn-sm" id="submitBtn" disabled>
                        <i class="bi bi-bookmark-plus-fill"></i> 加入自選股
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('modal-search');
    const resultsDiv = document.getElementById('modal-search-results');
    const selectedCode = document.getElementById('selected-stock-code');
    const selectedDisplay = document.getElementById('selected-stock-display');
    const selectedText = document.getElementById('selected-stock-text');
    const submitBtn = document.getElementById('submitBtn');

    let debounceTimer;

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        const q = searchInput.value.trim();
        if (q.length < 1) {
            resultsDiv.style.display = 'none';
            return;
        }
        debounceTimer = setTimeout(() => searchStocks(q), 350);
    });

    function searchStocks(q) {
        fetch(`/api/search?q=${encodeURIComponent(q)}&limit=10`)
            .then(r => r.json())
            .then(data => {
                if (!data.results || data.results.length === 0) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div style="padding:1rem;text-align:center;color:var(--text-muted);font-size:0.85rem;">
                        找不到符合的股票
                    </div>`;
                    return;
                }
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = data.results.map(s => `
                    <div class="search-result-item" onclick="selectStock('${s.code}', '${s.name}')">
                        <div style="display:flex;align-items:center;gap:0.625rem;">
                            <span style="font-family:var(--font-mono);font-size:0.8rem;font-weight:600;
                                         padding:0.15rem 0.5rem;background:rgba(0,212,255,0.08);
                                         border:1px solid rgba(0,212,255,0.2);border-radius:4px;color:var(--brand-cyan);">
                                ${s.code}
                            </span>
                            <span style="font-size:0.875rem;color:var(--text-primary);">${s.name}</span>
                        </div>
                        <i class="bi bi-plus-circle" style="color:var(--text-muted);"></i>
                    </div>
                `).join('');
            })
            .catch(() => {
                resultsDiv.style.display = 'none';
            });
    }

    function selectStock(code, name) {
        selectedCode.value = code;
        selectedText.textContent = `${name} (${code})`;
        selectedDisplay.style.display = 'block';
        resultsDiv.style.display = 'none';
        searchInput.value = '';
        submitBtn.disabled = false;
    }

    // Quick add: user enters code directly
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const v = searchInput.value.trim();
            if (v.length >= 4) {
                selectStock(v, v);
            }
        }
    });
</script>
{% endblock %}