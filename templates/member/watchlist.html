{% extends "layouts/base.html" %}

{% block title %}Watchlist | TST{% endblock %}

{% block content %}
<section class="section">
    <div class="container">

        <!-- Header -->
        <div class="flex justify-between items-center mb-xl">
            <div>
                <h2 class="h2 mb-xs">My Watchlist</h2>
                <p class="text-secondary">
                    {{ watchlist|length }} stocks
                    {% if features.watchlist_limit %}
                    (Limit: {{ features.watchlist_limit }})
                    {% endif %}
                </p>
            </div>
            <div class="flex gap-md">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStockModal">
                    <i class="bi bi-plus-circle me-sm"></i>Add Stock
                </button>
                <button class="btn btn-outline" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise me-sm"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="mb-lg p-md radius-md"
            style="background: {% if category == 'error' %}rgba(239, 68, 68, 0.1){% else %}rgba(34, 197, 94, 0.1){% endif %}; border: 1px solid {% if category == 'error' %}var(--color-danger){% else %}var(--color-success){% endif %}; color: {% if category == 'error' %}var(--color-danger){% else %}var(--color-success){% endif %};">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Watchlist Table -->
        {% if watchlist %}
        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Name</th>
                            <th class="text-right">Price</th>
                            <th class="text-right">Change</th>
                            <th class="text-right">Change %</th>
                            <th class="text-right">Cost</th>
                            <th class="text-right">P/L</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in watchlist %}
                        <tr>
                            <td>
                                <a href="{{ url_for('stock_page', code=item.stock_code) }}"
                                    class="badge badge-brand font-mono hover:text-white">
                                    {{ item.stock_code }}
                                </a>
                            </td>
                            <td>{{ item.stock_name or 'Loading...' }}</td>
                            <td class="text-right font-mono">
                                {% if item.current_price and item.current_price != 'N/A' %}
                                <span class="font-bold">{{ item.current_price|format_price }}</span>
                                {% else %}
                                <span class="text-secondary">Loading...</span>
                                {% endif %}
                            </td>
                            <td class="text-right font-mono">
                                {% if item.change and item.change != 'N/A' %}
                                <span class="{{ item.change|change_class }}">
                                    {{ item.change }}
                                </span>
                                {% else %}
                                <span class="text-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right font-mono">
                                {% if item.change_percent and item.change_percent != 'N/A' %}
                                <span class="{{ item.change_percent|change_class }}">
                                    {{ item.change_percent }}
                                </span>
                                {% else %}
                                <span class="text-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right font-mono text-secondary">
                                {{ item.added_price|format_price if item.added_price else '-' }}
                            </td>
                            <td class="text-right font-mono">
                                {% if item.current_price and item.added_price and item.current_price != 'N/A' %}
                                {% set profit = item.current_price|float - item.added_price|float %}
                                {% set profit_percent = (profit / item.added_price|float * 100) if
                                item.added_price|float > 0 else 0 %}
                                <span
                                    class="{{ 'text-up' if profit > 0 else 'text-down' if profit < 0 else 'text-secondary' }}">
                                    {{ '+' if profit > 0 else '' }}{{ profit|format_price }}
                                    ({{ '+' if profit_percent > 0 else '' }}{{ "%.2f"|format(profit_percent) }}%)
                                </span>
                                {% else %}
                                <span class="text-secondary">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right">
                                <div class="flex justify-end gap-sm">
                                    <a href="{{ url_for('stock_page', code=item.stock_code) }}"
                                        class="btn btn-sm btn-outline" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('remove_from_watchlist', item_id=item.id) }}"
                                        class="btn btn-sm btn-outline hover:border-danger hover:text-down"
                                        onclick="return confirm('Remove this stock?')" title="Remove">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="card text-center py-xl">
            <i class="bi bi-bookmark text-secondary mb-md block" style="font-size: 4rem; opacity: 0.3;"></i>
            <h3 class="h3 mb-sm">Your watchlist is empty</h3>
            <p class="text-secondary mb-lg">Start building your portfolio by adding stocks</p>
            <div class="flex justify-center gap-md">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStockModal">
                    <i class="bi bi-plus-circle me-sm"></i>Add First Stock
                </button>
                <a href="{{ url_for('home') }}" class="btn btn-outline">
                    <i class="bi bi-search me-sm"></i>Search Stocks
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Limit Warning -->
        {% if features.watchlist_limit and watchlist|length >= features.watchlist_limit %}
        <div class="mt-lg p-md radius-md flex items-center gap-md"
            style="background: rgba(255, 152, 0, 0.1); border: 1px solid var(--color-warning); color: var(--color-warning);">
            <i class="bi bi-exclamation-triangle"></i>
            <div>
                Watchlist limit reached ({{ features.watchlist_limit }}).
                {% if not current_user.is_premium() %}
                <a href="#" class="text-white underline">Upgrade</a> to increase limit.
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</section>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--bg-surface); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title h4">Add Stock</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_to_watchlist') }}">
                <div class="modal-body">
                    <div class="mb-md">
                        <label for="stock_code" class="text-secondary mb-xs block">Stock Code</label>
                        <input type="text" class="input" id="stock_code" name="stock_code" placeholder="e.g. 2330, 0050"
                            required pattern="[A-Za-z0-9]{3,10}">
                        <div class="text-secondary text-xs mt-xs">Supports TWSE/TPEX codes</div>
                    </div>
                    <div class="mb-md">
                        <label for="notes" class="text-secondary mb-xs block">Notes (Optional)</label>
                        <textarea class="input" id="notes" name="notes" rows="3"
                            placeholder="Investment thesis, target price..."></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add to Watchlist</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}