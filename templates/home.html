{% extends "layouts/base.html" %}

{% block title %}Taiwan Stock Terminal | Market Intelligence{% endblock %}

{% block content %}
<!-- Market Ticker -->
<div class="ticker-wrap">
    <div class="ticker">
        {% if market_info and not market_info.get('錯誤') %}
        {% for key, value in market_info.items() %}
        {% if key != '更新時間' %}
        <div class="ticker-item">
            {{ key }}: <span
                class="{% if '+' in value|string %}text-up{% elif '-' in value|string %}text-down{% endif %}">{{ value
                }}</span>
        </div>
        {% endif %}
        {% endfor %}
        <!-- Duplicate for seamless loop -->
        {% for key, value in market_info.items() %}
        {% if key != '更新時間' %}
        <div class="ticker-item">
            {{ key }}: <span
                class="{% if '+' in value|string %}text-up{% elif '-' in value|string %}text-down{% endif %}">{{ value
                }}</span>
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <div class="ticker-item">TSE: <span class="text-up">24,373.53 +39.05</span></div>
        <div class="ticker-item">OTC: <span class="text-up">245.67 +2.45</span></div>
        <div class="ticker-item">Futures: <span class="text-down">24,350 -15</span></div>
        <div class="ticker-item">Vol: <span>2,847B</span></div>
        <!-- Duplicate -->
        <div class="ticker-item">TSE: <span class="text-up">24,373.53 +39.05</span></div>
        <div class="ticker-item">OTC: <span class="text-up">245.67 +2.45</span></div>
        <div class="ticker-item">Futures: <span class="text-down">24,350 -15</span></div>
        <div class="ticker-item">Vol: <span>2,847B</span></div>
        {% endif %}
    </div>
</div>

<!-- Hero Section -->
<section class="hero text-center">
    <div class="container">
        <h1 class="h1 mb-lg">
            Market <span class="text-brand">Intelligence</span><br>
            Redefined.
        </h1>
        <p class="text-secondary mb-lg"
            style="font-size: 1.25rem; max-width: 600px; margin-left: auto; margin-right: auto;">
            Professional-grade data analysis and real-time insights for the Taiwan Stock Market.
        </p>

        <div style="max-width: 600px; margin: 0 auto; position: relative;">
            <form action="{{ url_for('stock_page') }}" method="GET">
                <div class="input-group">
                    <span
                        style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="code" class="input" placeholder="Search quote (e.g. 2330, TSMC)..."
                        style="padding-left: 3rem; height: 3.5rem; font-size: 1.1rem; border-radius: var(--radius-full); background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px);"
                        autocomplete="off" required>
                </div>
            </form>

            <div class="flex justify-center gap-md mt-lg flex-wrap">
                <a href="{{ url_for('stock_page', code='2330') }}" class="badge badge-brand">2330 TSMC</a>
                <a href="{{ url_for('stock_page', code='0050') }}" class="badge badge-brand">0050 0050 ETF</a>
                <a href="{{ url_for('stock_page', code='2317') }}" class="badge badge-brand">2317 Foxconn</a>
            </div>
        </div>
    </div>
</section>

<!-- Market Overview -->
<section class="section" style="padding-top: 0;">
    <div class="container">
        <div class="grid grid-cols-4-md grid-cols-2">
            {% if market_info and not market_info.get('錯誤') %}
            {% for key, value in market_info.items() %}
            {% if key != '更新時間' %}
            <div
                class="card card-glass flex flex-col items-center justify-center p-xl hover:border-brand transition-all duration-300">
                <div class="text-secondary font-mono text-sm uppercase tracking-wider mb-sm">{{ key }}</div>
                <div
                    class="h2 font-mono {% if '+' in value|string %}text-up{% elif '-' in value|string %}text-down{% endif %}">
                    {{ value or 'N/A' }}
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="card card-glass flex flex-col items-center justify-center p-xl">
                <div class="text-secondary font-mono text-sm uppercase tracking-wider mb-sm">TAIEX</div>
                <div class="h2 font-mono text-up">17,500.23</div>
            </div>
            <div class="card card-glass flex flex-col items-center justify-center p-xl">
                <div class="text-secondary font-mono text-sm uppercase tracking-wider mb-sm">CHANGE</div>
                <div class="h2 font-mono text-up">+125.45</div>
            </div>
            <div class="card card-glass flex flex-col items-center justify-center p-xl">
                <div class="text-secondary font-mono text-sm uppercase tracking-wider mb-sm">VOLUME</div>
                <div class="h2 font-mono">152.4B</div>
            </div>
            <div class="card card-glass flex flex-col items-center justify-center p-xl">
                <div class="text-secondary font-mono text-sm uppercase tracking-wider mb-sm">FOREIGN</div>
                <div class="h2 font-mono text-up">+8.5B</div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Main Content Grid -->
<section class="section">
    <div class="container">
        <div class="grid grid-cols-3-md gap-xl">

            <!-- Most Active -->
            <div class="col-span-2">
                <div class="flex justify-between items-center mb-lg">
                    <h2 class="h3">Most Active</h2>
                    <a href="#" class="btn btn-ghost" style="font-size: 0.9rem;">View All <i
                            class="bi bi-arrow-right"></i></a>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Change</th>
                                    <th class="text-right">%</th>
                                    <th class="text-right">Vol</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in popular_stocks %}
                                <tr onclick="window.location.href='{{ url_for('stock_page', code=stock.code) }}'"
                                    style="cursor: pointer;">
                                    <td><span class="badge badge-brand font-mono">{{ stock.code }}</span></td>
                                    <td style="font-weight: 500;">{{ stock.name }}</td>
                                    <td class="text-right font-mono">{{ stock.price }}</td>
                                    <td class="text-right font-mono">
                                        <span
                                            class="{% if '+' in stock.change %}text-up{% elif '-' in stock.change %}text-down{% endif %}">
                                            {{ stock.change }}
                                        </span>
                                    </td>
                                    <td class="text-right font-mono">
                                        <span
                                            class="{% if '+' in stock.change_percent %}text-up{% elif '-' in stock.change_percent %}text-down{% endif %}">
                                            {{ stock.change_percent }}
                                        </span>
                                    </td>
                                    <td class="text-right font-mono text-secondary">{{ stock.volume }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="flex" style="flex-direction: column; gap: var(--space-xl);">

                <!-- Market Status -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-activity"></i> Market Status</h3>
                    </div>
                    <div class="flex items-center gap-md">
                        <div
                            style="width: 10px; height: 10px; border-radius: 50%; background: var(--market-up); box-shadow: 0 0 10px var(--market-up);">
                        </div>
                        <span class="font-mono" style="font-weight: 600;">{{ 'MARKET OPEN' if market_open else 'MARKET
                            CLOSED' }}</span>
                    </div>
                    <div class="text-secondary mt-lg font-mono" style="font-size: 0.8rem;">
                        Last update: {{ current_time.strftime('%H:%M:%S') if current_time else 'N/A' }}
                    </div>
                </div>

                <!-- Tools -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tools</h3>
                    </div>
                    <div class="flex" style="flex-direction: column; gap: var(--space-sm);">
                        <a href="{{ url_for('dividend_calculator') }}" class="btn btn-outline justify-between">
                            <span><i class="bi bi-calculator"></i> Dividend Calc</span>
                            <i class="bi bi-chevron-right" style="font-size: 0.8rem;"></i>
                        </a>
                        <a href="{{ url_for('technical_analysis_tool') }}" class="btn btn-outline justify-between">
                            <span><i class="bi bi-graph-up"></i> Technical Analysis</span>
                            <i class="bi bi-chevron-right" style="font-size: 0.8rem;"></i>
                        </a>
                        <a href="{{ url_for('allocation_tool') }}" class="btn btn-outline justify-between">
                            <span><i class="bi bi-pie-chart"></i> Allocation</span>
                            <i class="bi bi-chevron-right" style="font-size: 0.8rem;"></i>
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Auto-uppercase for stock search
    document.querySelectorAll('input[name="code"]').forEach(input => {
        input.addEventListener('input', function () {
            this.value = this.value.toUpperCase();
        });
    });
</script>
{% endblock %}