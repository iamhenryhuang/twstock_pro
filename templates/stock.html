{% extends "layouts/base.html" %}

{% block title %}
{% if stock_info and stock_info.get('股票名稱') %}
{{ stock_code }} {{ stock_info['股票名稱'] }} | TST
{% else %}
Stock Quote | TST
{% endif %}
{% endblock %}

{% block content %}
<!-- Search Section (Compact) -->
<section
    style="background: var(--bg-surface); border-bottom: 1px solid var(--border-color); padding: var(--space-lg) 0;">
    <div class="container">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-md">
                <a href="{{ url_for('home') }}" class="text-secondary hover:text-white"><i class="bi bi-arrow-left"></i>
                    Back</a>
            </div>
            <div style="width: 300px;">
                <form action="{{ url_for('stock_page') }}" method="GET">
                    <div class="input-group">
                        <input type="text" name="code" class="input" placeholder="Search quote..."
                            value="{{ stock_code if stock_code else '' }}" autocomplete="off" required>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

{% if error %}
<section class="section">
    <div class="container text-center">
        <div class="card" style="max-width: 600px; margin: 0 auto; border-color: var(--market-down);">
            <div style="font-size: 3rem; color: var(--market-down); margin-bottom: var(--space-lg);">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <h3 class="h3 mb-md">Stock Not Found</h3>
            <p class="text-secondary mb-lg">{{ error }}</p>
            <a href="{{ url_for('home') }}" class="btn btn-primary">Back to Home</a>
        </div>
    </div>
</section>
{% elif stock_info %}

<!-- Stock Header -->
<section
    style="padding: var(--space-xl) 0; background: linear-gradient(to bottom, var(--bg-surface) 0%, var(--bg-body) 100%);">
    <div class="container">
        <div class="flex justify-between items-center flex-wrap gap-lg">
            <div>
                <div class="flex items-center gap-md mb-sm">
                    <span class="badge badge-brand font-mono" style="font-size: 1.2rem;">{{ stock_code }}</span>
                    <h1 class="h2" style="margin: 0;">{{ stock_info.get('股票名稱', 'Unknown') }}</h1>
                </div>
                <div class="flex gap-lg text-secondary" style="font-size: 0.9rem;">
                    <span><i class="bi bi-check-circle"></i> Real-time Data</span>
                    <span><i class="bi bi-clock"></i> {{ current_time.strftime('%H:%M:%S') if current_time else 'N/A'
                        }}</span>
                    {% if stock_info.get('產業別') %}
                    <span><i class="bi bi-tag"></i> {{ stock_info['產業別'] }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="flex gap-md">
                {% if current_user.is_authenticated %}
                {% if in_watchlist %}
                <button class="btn btn-ghost text-up" disabled>
                    <i class="bi bi-bookmark-check-fill"></i> In Watchlist
                </button>
                {% else %}
                <form method="POST" action="{{ url_for('add_to_watchlist') }}">
                    <input type="hidden" name="stock_code" value="{{ stock_code }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-bookmark-plus"></i> Watch
                    </button>
                </form>
                {% endif %}
                {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-primary">
                    <i class="bi bi-bookmark-plus"></i> Watch
                </a>
                {% endif %}
                <button class="btn btn-outline" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Price Cards -->
        <div class="grid grid-cols-4-md grid-cols-2 mt-lg">
            <div class="card" style="border-left: 4px solid var(--color-brand-primary);">
                <div class="text-secondary font-mono" style="font-size: 0.8rem; text-transform: uppercase;">Price</div>
                <div
                    class="h2 font-mono {% if stock_info.get('漲跌價差', '').startswith('+') %}text-up{% elif stock_info.get('漲跌價差', '').startswith('-') %}text-down{% endif %}">
                    {{ stock_info.get('即時股價', stock_info.get('收盤價', 'N/A')) }}
                </div>
            </div>
            <div class="card">
                <div class="text-secondary font-mono" style="font-size: 0.8rem; text-transform: uppercase;">Change</div>
                <div
                    class="h3 font-mono {% if stock_info.get('漲跌價差', '').startswith('+') %}text-up{% elif stock_info.get('漲跌價差', '').startswith('-') %}text-down{% endif %}">
                    {{ stock_info.get('漲跌價差', 'N/A') }}
                </div>
            </div>
            <div class="card">
                <div class="text-secondary font-mono" style="font-size: 0.8rem; text-transform: uppercase;">Change %
                </div>
                <div
                    class="h3 font-mono {% if stock_info.get('漲跌幅', '').startswith('+') %}text-up{% elif stock_info.get('漲跌幅', '').startswith('-') %}text-down{% endif %}">
                    {{ stock_info.get('漲跌幅', 'N/A') }}
                </div>
            </div>
            <div class="card">
                <div class="text-secondary font-mono" style="font-size: 0.8rem; text-transform: uppercase;">Volume</div>
                <div class="h3 font-mono">{{ stock_info.get('成交量', 'N/A') }}</div>
            </div>
        </div>
    </div>
</section>

<!-- Chart Section -->
<section class="section" style="padding-top: 0;">
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Price Chart</h3>
                <div class="flex gap-sm">
                    <button type="button" class="btn btn-sm btn-outline active bloomberg-chart-btn"
                        data-days="3">3D</button>
                    <button type="button" class="btn btn-sm btn-outline bloomberg-chart-btn" data-days="7">7D</button>
                    <button type="button" class="btn btn-sm btn-outline bloomberg-chart-btn" data-days="14">14D</button>
                    <button type="button" class="btn btn-sm btn-outline bloomberg-chart-btn" data-days="30">30D</button>
                </div>
            </div>
            <div style="position: relative; height: 400px; width: 100%;">
                <div id="chart-loading" class="flex items-center justify-center" style="height: 100%;">
                    <div class="text-secondary">Loading Chart...</div>
                </div>
                <canvas id="stockChart" style="display: none;"></canvas>
                <div id="chart-error" class="flex items-center justify-center" style="height: 100%; display: none;">
                    <div class="text-center">
                        <div class="text-down mb-sm"><i class="bi bi-exclamation-triangle"></i></div>
                        <div class="text-secondary">Unable to load chart data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Details Section -->
<section class="section" style="padding-top: 0;">
    <div class="container">
        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: var(--space-xl);">

            <!-- Trading Info -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Trading Information</h3>
                </div>
                <table class="table">
                    <tbody>
                        {% set trading_items = [
                        ('Open', stock_info.get('開盤價')),
                        ('High', stock_info.get('最高價')),
                        ('Low', stock_info.get('最低價')),
                        ('Volume (Shares)', stock_info.get('成交股數')),
                        ('Trades', stock_info.get('成交筆數')),
                        ('Value', stock_info.get('成交金額'))
                        ] %}
                        {% for label, value in trading_items %}
                        {% if value and value != 'N/A' %}
                        <tr>
                            <td class="text-secondary">{{ label }}</td>
                            <td class="text-right font-mono" style="font-weight: 600;">{{ value }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Company Info -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Company Profile</h3>
                </div>
                <table class="table">
                    <tbody>
                        <tr>
                            <td class="text-secondary">Symbol</td>
                            <td class="text-right"><span class="badge badge-brand font-mono">{{ stock_code }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-secondary">Name</td>
                            <td class="text-right">{{ stock_info.get('股票名稱', 'N/A') }}</td>
                        </tr>
                        {% if stock_info.get('上市日期') %}
                        <tr>
                            <td class="text-secondary">Listed</td>
                            <td class="text-right font-mono">{{ stock_info['上市日期'] }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</section>

{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Pass data to JS
    window.stockData = {
        stockCode: {% if stock_code %}'{{ stock_code }}'{% else %} null{% endif %},
    hasStockInfo: {% if stock_info %} true{% else %} false{% endif %}
    };
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stockCode = window.stockData.stockCode;

        // Auto-uppercase search
        document.querySelectorAll('input[name="code"]').forEach(input => {
            input.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });
        });

        // Chart Logic
        if (stockCode && window.stockData.hasStockInfo) {
            loadStockChart(3); // Default 3 days

            document.querySelectorAll('.bloomberg-chart-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.bloomberg-chart-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadStockChart(this.getAttribute('data-days'));
                });
            });
        }
    });

    let stockChart = null;

    function loadStockChart(days) {
        const ctx = document.getElementById('stockChart');
        const loading = document.getElementById('chart-loading');
        const error = document.getElementById('chart-error');

        if (!ctx) return;

        loading.style.display = 'flex';
        ctx.style.display = 'none';
        error.style.display = 'none';

        if (stockChart) {
            stockChart.destroy();
        }

        fetch(`/api/stock/${window.stockData.stockCode}/chart?days=${days}`)
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';
                if (data.success && data.data && data.data.length > 0) {
                    ctx.style.display = 'block';
                    createChart(ctx, data.data);
                } else {
                    error.style.display = 'flex';
                }
            })
            .catch(err => {
                console.error(err);
                loading.style.display = 'none';
                error.style.display = 'flex';
            });
    }

    function createChart(ctx, data) {
        // Prepare data
        const labels = data.map(d => d.time); // Assuming API returns 'time'
        const prices = data.map(d => d.price); // Assuming API returns 'price'

        // Chart Colors
        const borderColor = '#00E5FF';
        const backgroundColor = 'rgba(0, 229, 255, 0.1)';
        const gridColor = 'rgba(255, 255, 255, 0.05)';
        const textColor = '#A0A0A0';

        stockChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price',
                    data: prices,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(10, 10, 10, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: textColor, maxTicksLimit: 8 }
                    },
                    y: {
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }
</script>
{% endblock %}