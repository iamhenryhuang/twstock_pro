{% extends "layouts/base.html" %}

{% block title %}
{% if stock_info %}
{{ stock_info['股票名稱'] }} ({{ stock_code }}) - TWStock Pro
{% else %}
Stock Not Found - TWStock Pro
{% endif %}
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Error Message -->
    {% if error %}
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
        <div>{{ error }}</div>
    </div>
    {% endif %}

    <!-- Search Bar (if explicit search on this page) or Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">首頁</a></li>
            {% if stock_info %}
            <li class="breadcrumb-item active" aria-current="page">{{ stock_info['股票名稱'] }} ({{ stock_code }})</li>
            {% else %}
            <li class="breadcrumb-item active" aria-current="page">搜尋結果</li>
            {% endif %}
        </ol>
    </nav>

    {% if stock_info and not stock_info.get('錯誤') %}
    <div class="row g-4">
        <!-- Stock Header Section -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                        <div>
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h2 class="fw-bold mb-0">{{ stock_info['股票名稱'] }}</h2>
                                <span class="badge bg-secondary">{{ stock_code }}</span>
                                <span class="badge border">{{ stock_info.get('產業別', '一般') }}</span>
                            </div>
                            <div class="text-secondary small">資料時間: {{ current_time.strftime('%Y-%m-%d %H:%M:%S') }}
                            </div>
                        </div>

                        <div class="text-end">
                            <div
                                class="display-4 fw-bold {{ 'text-danger' if '-' in stock_info.get('漲跌價差', '') else 'text-success' }}">
                                {{ stock_info.get('即時股價', stock_info.get('收盤價', 'N/A')) }}
                            </div>
                            <div class="d-flex align-items-center justify-content-end gap-3 fs-5">
                                <span
                                    class="{{ 'text-danger' if '-' in stock_info.get('漲跌價差', '') else 'text-success' }}">
                                    <i
                                        class="bi {{ 'bi-caret-down-fill' if '-' in stock_info.get('漲跌價差', '') else 'bi-caret-up-fill' }}"></i>
                                    {{ stock_info.get('漲跌價差', 'N/A') }}
                                </span>
                                <span
                                    class="{{ 'text-danger' if '-' in stock_info.get('漲跌幅', '') else 'text-success' }}">
                                    ({{ stock_info.get('漲跌幅', 'N/A') }})
                                </span>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Key Stats Grid -->
                    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3 text-center">
                        <div class="col">
                            <small class="text-secondary d-block mb-1">開盤價</small>
                            <span class="fw-bold">{{ stock_info.get('開盤價', '-') }}</span>
                        </div>
                        <div class="col">
                            <small class="text-secondary d-block mb-1">最高價</small>
                            <span class="fw-bold text-danger">{{ stock_info.get('最高價', '-') }}</span>
                        </div>
                        <div class="col">
                            <small class="text-secondary d-block mb-1">最低價</small>
                            <span class="fw-bold text-success">{{ stock_info.get('最低價', '-') }}</span>
                        </div>
                        <div class="col">
                            <small class="text-secondary d-block mb-1">成交量</small>
                            <span class="fw-bold">{{ stock_info.get('成交量', '-') }}</span>
                        </div>
                        <div class="col">
                            <small class="text-secondary d-block mb-1">本益比</small>
                            <span class="fw-bold">{{ stock_info.get('本益比', '-') }}</span>
                        </div>
                        <div class="col">
                            <small class="text-secondary d-block mb-1">殖利率</small>
                            <span class="fw-bold">{{ stock_info.get('殖利率', '-') }}%</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2 mt-4">
                        {% if current_user.is_authenticated %}
                        {% if in_watchlist %}
                        <button class="btn btn-outline-danger" data-bs-toggle="modal"
                            data-bs-target="#removeFromWatchlistModal">
                            <i class="bi bi-bookmark-x-fill me-1"></i>移除自選
                        </button>
                        {% else %}
                        <button class="btn btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#addToWatchlistModal">
                            <i class="bi bi-bookmark-plus me-1"></i>加入自選
                        </button>
                        {% endif %}
                        {% else %}
                        <a href="{{ url_for('login', next=request.url) }}" class="btn btn-outline-primary">
                            <i class="bi bi-bookmark-plus me-1"></i>登入後加入自選
                        </a>
                        {% endif %}

                        <a href="https://tw.stock.yahoo.com/quote/{{ stock_code }}" target="_blank"
                            class="btn btn-outline-secondary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Yahoo股市
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="col-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-graph-up me-2 text-primary"></i>股價走勢圖</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active"
                            onclick="updateChart(7)">1週</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="updateChart(30)">1月</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="stockChart">
                        <!-- Chart will be rendered here -->
                        <div class="text-center py-5 text-secondary">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>載入圖表資料中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add to Watchlist Modal -->
    <div class="modal fade" id="addToWatchlistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('add_to_watchlist') }}" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">加入自選股</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="stock_code" value="{{ stock_code }}">
                        <p>確定要將 <strong>{{ stock_info['股票名稱'] }} ({{ stock_code }})</strong> 加入自選股嗎？</p>
                        <div class="mb-3">
                            <label for="notes" class="form-label">備註 (選填)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">確認加入</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stockCode = "{{ stock_code }}";
        if (stockCode) {
            fetchChartData(stockCode, 7);
        }
    });

    function updateChart(days) {
        // Update active button state
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const stockCode = "{{ stock_code }}";
        fetchChartData(stockCode, days);
    }

    function fetchChartData(stockCode, days) {
        const chartContainer = document.querySelector('#stockChart');
        // chartContainer.innerHTML = '... loading ...'; // Keep existing spinner if possible or reset

        fetch(`/api/stock/${stockCode}/chart?days=${days}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderChart(data.data);
                } else {
                    chartContainer.innerHTML = `<div class="alert alert-warning text-center">${data.error || '無法載入圖表'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                chartContainer.innerHTML = `<div class="alert alert-danger text-center">圖表載入失敗</div>`;
            });
    }

    function renderChart(chartData) {
        // Format data for ApexCharts
        // Assuming API returns { date: [], price: [], ... } or list of objects
        // Let's adapt based on typical structure. 
        // If we don't know the exact structure, we might need to debug. 
        // But let's assume standard list of {date, close}

        // Simple adaptation if data is list of dicts
        const dates = chartData.map(item => item.date || item.Date);
        const prices = chartData.map(item => item.close || item.Close || item.price);

        var options = {
            series: [{
                name: '收盤價',
                data: prices
            }],
            chart: {
                type: 'area',
                height: 350,
                toolbar: { show: false },
                zoom: { enabled: false }
            },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: {
                categories: dates,
                labels: { show: false }, // Hide dense labels
                tooltip: { enabled: false }
            },
            tooltip: {
                x: { format: 'yyyy/MM/dd' },
            },
            colors: ['#0d6efd'],
            theme: {
                mode: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.3,
                    stops: [0, 90, 100]
                }
            },
            grid: {
                borderColor: 'var(--color-border)',
                strokeDashArray: 4,
            },
            tooltip: {
                theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
            }
        };

        document.querySelector("#stockChart").innerHTML = "";
        var chart = new ApexCharts(document.querySelector("#stockChart"), options);
        chart.render();

        // Listen for theme changes to update chart (only if this script is active)
        window.removeEventListener('themeChanged', handleThemeChange); // Prevent multiple listeners
        window.addEventListener('themeChanged', handleThemeChange);

        function handleThemeChange(e) {
            const newTheme = e.detail.theme;
            chart.updateOptions({
                theme: { mode: newTheme === 'dark' ? 'dark' : 'light' },
                tooltip: { theme: newTheme === 'dark' ? 'dark' : 'light' }
            });
        }
    }
</script>
{% endblock %}